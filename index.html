<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xolo AI â€” Credit Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.7/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300..800;1,9..40,300..800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
:root {
    --bg-base: #0a0e1a;
    --bg-surface: #111827;
    --bg-card: #1a2236;
    --bg-card-hover: #1f2b42;
    --bg-input: #0d1220;
    --border: #2a3550;
    --border-active: #6366f1;
    --text-primary: #e8ecf4;
    --text-secondary: #8892a8;
    --text-muted: #5a6478;
    --accent-indigo: #6366f1;
    --accent-violet: #8b5cf6;
    --accent-emerald: #10b981;
    --accent-amber: #f59e0b;
    --accent-rose: #f43f5e;
    --accent-cyan: #06b6d4;
    --accent-blue: #3b82f6;
    --accent-lime: #84cc16;
    --accent-orange: #f97316;
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 14px;
    --radius-xl: 18px;
    --shadow-card: 0 2px 12px rgba(0,0,0,.35);
    --shadow-elevated: 0 8px 30px rgba(0,0,0,.5);
    --font-sans: 'DM Sans', system-ui, -apple-system, sans-serif;
    --font-mono: 'JetBrains Mono', 'SF Mono', monospace;
    --transition: .2s cubic-bezier(.4,0,.2,1);
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
body { font-family: var(--font-sans); background: var(--bg-base); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }

.app-shell { max-width: 1440px; margin: 0 auto; padding: 1.5rem; }

.header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 1.25rem 1.75rem; background: var(--bg-surface);
    border: 1px solid var(--border); border-radius: var(--radius-xl); margin-bottom: 1.25rem;
}
.header-left { display: flex; align-items: center; gap: 1rem; }
.logo-mark {
    width: 42px; height: 42px;
    background: linear-gradient(135deg, var(--accent-indigo), var(--accent-violet));
    border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;
    font-size: 1.4rem; font-weight: 800; color: #fff;
}
.header h1 { font-size: 1.35rem; font-weight: 700; letter-spacing: -.02em; }
.header h1 span { color: var(--accent-indigo); }
.header-subtitle { font-size: .8rem; color: var(--text-muted); font-weight: 500; }
.header-right { display: flex; align-items: center; gap: .75rem; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-emerald); box-shadow: 0 0 8px rgba(16,185,129,.5); }
.status-dot.loading { background: var(--accent-amber); animation: pulse-dot 1.2s infinite; }
.status-dot.error { background: var(--accent-rose); }
.status-dot.warning { background: var(--accent-amber); }
@keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:.4} }

/* TABS */
.tab-bar { display: flex; gap: .35rem; padding: .35rem; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-lg); margin-bottom: 1.25rem; overflow-x: auto; scrollbar-width: none; }
.tab-bar::-webkit-scrollbar { display: none; }
.tab-btn { padding: .6rem 1.1rem; background: transparent; border: none; color: var(--text-secondary); font-family: var(--font-sans); font-size: .82rem; font-weight: 600; border-radius: var(--radius-md); cursor: pointer; white-space: nowrap; transition: var(--transition); }
.tab-btn:hover { color: var(--text-primary); background: var(--bg-card); }
.tab-btn.active { background: var(--accent-indigo); color: #fff; box-shadow: 0 2px 10px rgba(99,102,241,.35); }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* CONTROLS */
.controls-bar { display: flex; flex-wrap: wrap; gap: .75rem; align-items: flex-end; padding: 1.25rem; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-lg); margin-bottom: 1.25rem; }
.ctrl-group { display: flex; flex-direction: column; gap: .35rem; }
.ctrl-group label { font-size: .72rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .06em; }
.ctrl-input, .ctrl-select { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary); padding: .55rem .85rem; border-radius: var(--radius-sm); font-family: var(--font-sans); font-size: .85rem; min-width: 150px; transition: var(--transition); }
.ctrl-input:focus, .ctrl-select:focus { outline: none; border-color: var(--accent-indigo); box-shadow: 0 0 0 3px rgba(99,102,241,.15); }
.btn { display: inline-flex; align-items: center; gap: .45rem; padding: .55rem 1.25rem; border: none; border-radius: var(--radius-sm); font-family: var(--font-sans); font-size: .85rem; font-weight: 600; cursor: pointer; transition: var(--transition); white-space: nowrap; }
.btn-primary { background: var(--accent-indigo); color: #fff; }
.btn-primary:hover { background: #5558e6; transform: translateY(-1px); box-shadow: 0 4px 14px rgba(99,102,241,.3); }
.btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
.btn-secondary:hover { border-color: var(--accent-indigo); }
.btn-success { background: var(--accent-emerald); color: #fff; }
.btn-success:hover { background: #059669; }
.btn:disabled { opacity: .5; cursor: not-allowed; transform: none !important; }
.ctrl-spacer { flex: 1; min-width: 1rem; }

/* TOGGLE */
.toggle-group { display: inline-flex; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-sm); overflow: hidden; }
.toggle-btn { padding: .5rem .9rem; background: transparent; border: none; color: var(--text-secondary); font-family: var(--font-sans); font-size: .78rem; font-weight: 600; cursor: pointer; transition: var(--transition); }
.toggle-btn.active { background: var(--accent-indigo); color: #fff; }
.toggle-btn:hover:not(.active) { color: var(--text-primary); }

/* CHIPS */
.chip-filters { display: flex; flex-wrap: wrap; gap: .4rem; padding: .75rem 1.25rem; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-lg); margin-bottom: 1.25rem; }
.chip-filters-label { font-size: .72rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .06em; width: 100%; margin-bottom: .25rem; }
.chip { padding: .3rem .7rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 100px; font-family: var(--font-sans); font-size: .75rem; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: var(--transition); user-select: none; }
.chip:hover { border-color: var(--accent-indigo); color: var(--text-primary); }
.chip.active { background: rgba(99,102,241,.15); border-color: var(--accent-indigo); color: var(--accent-indigo); }
.chip.chip-all { font-weight: 700; }

/* METRICS */
.metrics-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1.25rem; }
.metric-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.25rem; position: relative; transition: var(--transition); }
.metric-card:hover { border-color: var(--border-active); transform: translateY(-2px); box-shadow: var(--shadow-card); }
.metric-label { font-size: .72rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .06em; display: flex; align-items: center; gap: .4rem; margin-bottom: .6rem; }
.metric-value { font-size: 1.85rem; font-weight: 800; letter-spacing: -.03em; font-family: var(--font-mono); }
.metric-sub { font-size: .78rem; color: var(--text-secondary); margin-top: .3rem; }
.metric-trend { display: inline-flex; align-items: center; gap: .2rem; font-size: .75rem; font-weight: 600; padding: .15rem .45rem; border-radius: 100px; }
.metric-trend.up { background: rgba(16,185,129,.12); color: var(--accent-emerald); }
.metric-trend.down { background: rgba(244,63,94,.12); color: var(--accent-rose); }
.mc-indigo .metric-value { color: var(--accent-indigo); }
.mc-emerald .metric-value { color: var(--accent-emerald); }
.mc-amber .metric-value { color: var(--accent-amber); }
.mc-rose .metric-value { color: var(--accent-rose); }
.mc-cyan .metric-value { color: var(--accent-cyan); }
.mc-violet .metric-value { color: var(--accent-violet); }
.mc-blue .metric-value { color: var(--accent-blue); }
.mc-orange .metric-value { color: var(--accent-orange); }

/* INFO TOOLTIP */
.info-icon { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; background: var(--bg-input); border: 1px solid var(--border); font-size: .6rem; font-weight: 700; color: var(--text-muted); cursor: help; position: relative; flex-shrink: 0; }
.info-icon::after { content: attr(data-tooltip); position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: var(--bg-base); border: 1px solid var(--border); color: var(--text-secondary); padding: .6rem .85rem; border-radius: var(--radius-sm); font-size: .72rem; font-weight: 400; line-height: 1.45; white-space: normal; width: max-content; max-width: 360px; opacity: 0; pointer-events: none; transition: opacity .2s; z-index: 999; box-shadow: var(--shadow-elevated); text-transform: none; letter-spacing: 0; font-family: var(--font-sans); }
.info-icon:hover::after { opacity: 1; }

/* CHARTS */
.chart-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1.25rem; }
.chart-panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
.chart-panel-title { font-size: .95rem; font-weight: 700; display: flex; align-items: center; gap: .5rem; }
.chart-wrap { position: relative; height: 300px; }

/* TABLES */
.data-table-wrap { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 1.25rem; }
.data-table-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); }
.data-table-title { font-size: .95rem; font-weight: 700; display: flex; align-items: center; gap: .5rem; }
.data-table { width: 100%; border-collapse: collapse; }
.data-table th, .data-table td { padding: .7rem 1rem; text-align: left; border-bottom: 1px solid rgba(42,53,80,.5); font-size: .82rem; }
.data-table th { background: var(--bg-surface); font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .05em; font-size: .7rem; position: sticky; top: 0; }
.data-table tbody tr:hover td { background: var(--bg-card-hover); }
.data-table .mono { font-family: var(--font-mono); font-weight: 600; }
.data-table .text-right { text-align: right; }

/* INSIGHTS */
.insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 1rem; margin-bottom: 1.25rem; }
.insight-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.25rem; }
.insight-card-header { display: flex; align-items: center; gap: .5rem; margin-bottom: .75rem; }
.insight-icon { width: 32px; height: 32px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1rem; }
.insight-card-title { font-size: .85rem; font-weight: 700; }
.insight-card-body { font-size: .82rem; color: var(--text-secondary); line-height: 1.55; }
.insight-card-body strong { color: var(--text-primary); }

/* PROJECTIONS */
.projection-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1.25rem; }
.projection-title { font-size: 1.05rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: .5rem; }
.sim-input-row { display: flex; flex-wrap: wrap; gap: .75rem; align-items: flex-end; margin-bottom: 1rem; }
.comparison-table { width: 100%; border-collapse: collapse; }
.comparison-table th, .comparison-table td { padding: .65rem .85rem; text-align: center; border-bottom: 1px solid rgba(42,53,80,.5); font-size: .8rem; }
.comparison-table th { background: var(--bg-surface); font-weight: 600; color: var(--text-muted); font-size: .7rem; text-transform: uppercase; letter-spacing: .05em; }

/* CALIBRATION BANNER */
.calibration-banner { background: linear-gradient(135deg, rgba(99,102,241,.08), rgba(139,92,246,.08)); border: 1px solid rgba(99,102,241,.3); border-radius: var(--radius-lg); padding: 1.25rem; margin-bottom: 1.25rem; }
.calibration-banner-title { font-size: .9rem; font-weight: 700; margin-bottom: .5rem; display: flex; align-items: center; gap: .5rem; }
.calibration-row { display: flex; flex-wrap: wrap; gap: .75rem; align-items: flex-end; }
.calibration-info { font-size: .78rem; color: var(--text-secondary); margin-top: .5rem; }

/* LOADING */
.loading-overlay { position: fixed; inset: 0; background: rgba(10,14,26,.92); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(4px); }
.loading-overlay.hidden { display: none; }
.loading-spinner { width: 48px; height: 48px; border: 3px solid var(--border); border-top-color: var(--accent-indigo); border-radius: 50%; animation: spin .8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-label { margin-top: 1rem; color: var(--text-secondary); font-size: .9rem; }
.loading-progress { margin-top: .5rem; color: var(--text-muted); font-size: .78rem; font-family: var(--font-mono); }

.empty-state { text-align: center; padding: 3rem 2rem; color: var(--text-muted); }
.empty-state-icon { font-size: 2.5rem; margin-bottom: .75rem; }

.badge { display: inline-block; padding: .15rem .5rem; border-radius: 100px; font-size: .7rem; font-weight: 600; }
.badge-danger { background: rgba(244,63,94,.15); color: var(--accent-rose); }
.badge-warning { background: rgba(245,158,11,.15); color: var(--accent-amber); }
.badge-success { background: rgba(16,185,129,.15); color: var(--accent-emerald); }

.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
@media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }
@media (max-width: 768px) {
    .app-shell { padding: .75rem; }
    .header { flex-direction: column; gap: .75rem; text-align: center; }
    .metrics-row { grid-template-columns: repeat(2, 1fr); }
    .insights-grid { grid-template-columns: 1fr; }
    .controls-bar { flex-direction: column; align-items: stretch; }
    .ctrl-spacer { display: none; }
}
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>

<div class="loading-overlay hidden" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-label">Cargando datos de analÃ­tica...</div>
    <div class="loading-progress" id="loadingProgress"></div>
</div>

<div class="app-shell">

    <header class="header">
        <div class="header-left">
            <div class="logo-mark">X</div>
            <div>
                <h1>Xolo <span>Credit Analytics</span></h1>
                <div class="header-subtitle">Dashboard de anÃ¡lisis de costos y crÃ©ditos Voiceflow</div>
            </div>
        </div>
        <div class="header-right">
            <div class="status-dot" id="statusDot"></div>
            <span style="font-size:.78rem;color:var(--text-muted)" id="statusText">Listo</span>
        </div>
    </header>

    <nav class="tab-bar" id="tabBar">
        <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
        <button class="tab-btn" data-tab="grade-3">3Â°</button>
        <button class="tab-btn" data-tab="grade-4">4Â°</button>
        <button class="tab-btn" data-tab="grade-5">5Â°</button>
        <button class="tab-btn" data-tab="grade-6">6Â°</button>
        <button class="tab-btn" data-tab="grade-7">7Â°</button>
        <button class="tab-btn" data-tab="grade-8">8Â°</button>
        <button class="tab-btn" data-tab="grade-9">9Â°</button>
        <button class="tab-btn" data-tab="grade-10">10Â°</button>
        <button class="tab-btn" data-tab="grade-11">11Â°</button>
        <button class="tab-btn" data-tab="grade-12">12Â°</button>
        <button class="tab-btn" data-tab="projections">âš¡ Proyecciones</button>
    </nav>

    <!-- CALIBRATION -->
    <div class="calibration-banner" id="calibrationBanner">
        <div class="calibration-banner-title">ğŸ”§ CalibraciÃ³n de CrÃ©ditos Reales</div>
        <p style="font-size:.82rem;color:var(--text-secondary);margin-bottom:.75rem;">
            Ingresa el total de crÃ©ditos reportado por Voiceflow (Settings â†’ Billing) para calibrar los cÃ¡lculos.
            La API de Analytics solo reporta interacciones, usuarios y tokens; no crÃ©ditos directos.
            Con el total real, el dashboard distribuye los crÃ©ditos proporcionalmente por grado y perÃ­odo.
        </p>
        <div class="calibration-row">
            <div class="ctrl-group">
                <label>Total CrÃ©ditos VF (Reportado)</label>
                <input type="number" class="ctrl-input" id="vfReportedCredits" value="1461581" min="0" style="width:180px">
            </div>
            <div class="ctrl-group">
                <label>Plan Total CrÃ©ditos</label>
                <input type="number" class="ctrl-input" id="planTotalCredits" value="2400000" min="0" style="width:160px">
            </div>
            <div class="ctrl-group">
                <label>Costo Plan (USD)</label>
                <input type="number" class="ctrl-input" id="planCostUSD" value="10800" min="0" step="0.01" style="width:120px">
            </div>
            <button class="btn btn-primary" onclick="if(STATE.loaded) renderAll()">Recalcular</button>
        </div>
        <div class="calibration-info">
            <span class="info-icon" data-tooltip="Los crÃ©ditos se distribuyen proporcionalmente entre grados y meses segÃºn la cantidad de interacciones. Esto asegura que el total coincida con lo que reporta VF.">i</span>
            Los crÃ©ditos se distribuyen proporcionalmente usando las interacciones como peso. Cada interacciÃ³n puede disparar mÃºltiples llamadas LLM (prompt steps, KB queries, agent steps), por lo que 1 interacciÃ³n â‰  1 crÃ©dito.
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="controls-bar">
        <div class="ctrl-group">
            <label>PerÃ­odo</label>
            <select class="ctrl-select" id="periodPreset">
                <option value="this_month">Este mes</option>
                <option value="last_month">Mes pasado</option>
                <option value="last_3">Ãšltimos 3 meses</option>
                <option value="last_6">Ãšltimos 6 meses</option>
                <option value="all" selected>Todo el historial</option>
                <option value="custom">Personalizado</option>
            </select>
        </div>
        <div class="ctrl-group" id="customDateStart" style="display:none">
            <label>Desde</label>
            <input type="date" class="ctrl-input" id="startDate" value="2025-01-05">
        </div>
        <div class="ctrl-group" id="customDateEnd" style="display:none">
            <label>Hasta</label>
            <input type="date" class="ctrl-input" id="endDate">
        </div>
        <div class="ctrl-group">
            <label>Unidad</label>
            <div class="toggle-group" id="unitToggle">
                <button class="toggle-btn active" data-unit="credits">CrÃ©ditos</button>
                <button class="toggle-btn" data-unit="cost">USD $</button>
            </div>
        </div>
        <div class="ctrl-spacer"></div>
        <button class="btn btn-primary" id="btnFetch" onclick="fetchAllData()">â–¶ Cargar Datos</button>
        <button class="btn btn-secondary" onclick="exportCSV()">â†“ CSV</button>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD TAB â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-content active" id="tab-dashboard">
        <div class="metrics-row" id="globalMetrics">
            <div class="metric-card mc-indigo">
                <div class="metric-label">Total CrÃ©ditos Consumidos <span class="info-icon" data-tooltip="Valor real ingresado desde Voiceflow. Se distribuye proporcionalmente entre grados y perÃ­odos segÃºn las interacciones registradas por la API.">i</span></div>
                <div class="metric-value" id="kpiTotalCredits">â€”</div>
                <div class="metric-sub" id="kpiTotalCreditsSub"></div>
            </div>
            <div class="metric-card mc-emerald">
                <div class="metric-label">CrÃ©ditos Restantes <span class="info-icon" data-tooltip="Plan total de crÃ©ditos - crÃ©ditos consumidos (reportado por VF).">i</span></div>
                <div class="metric-value" id="kpiRemaining">â€”</div>
                <div class="metric-sub" id="kpiRemainingSub"></div>
            </div>
            <div class="metric-card mc-amber">
                <div class="metric-label">CrÃ©ditos / InteracciÃ³n <span class="info-icon" data-tooltip="Total crÃ©ditos VF Ã· total interacciones. Promedio real de crÃ©ditos por cada mensaje enviado. Incluye orquestaciÃ³n + LLM + otros procesos.">i</span></div>
                <div class="metric-value" id="kpiCredPerInt">â€”</div>
                <div class="metric-sub" id="kpiCredPerIntSub"></div>
            </div>
            <div class="metric-card mc-rose">
                <div class="metric-label">Burn Rate Mensual <span class="info-icon" data-tooltip="Total crÃ©ditos VF Ã· meses con actividad. Promedio de crÃ©ditos consumidos por mes calendario.">i</span></div>
                <div class="metric-value" id="kpiBurnRate">â€”</div>
                <div class="metric-sub" id="kpiBurnRateSub"></div>
            </div>
            <div class="metric-card mc-cyan">
                <div class="metric-label">Total Interacciones <span class="info-icon" data-tooltip="Mensajes totales registrados por la API de Voiceflow Analytics.">i</span></div>
                <div class="metric-value" id="kpiTotalMsgs">â€”</div>
                <div class="metric-sub" id="kpiTotalMsgsSub"></div>
            </div>
            <div class="metric-card mc-violet">
                <div class="metric-label">Total Conversaciones <span class="info-icon" data-tooltip="Usuarios Ãºnicos por dÃ­a por proyecto. Cada usuario Ãºnico en un dÃ­a se cuenta como una conversaciÃ³n.">i</span></div>
                <div class="metric-value" id="kpiTotalConvs">â€”</div>
                <div class="metric-sub" id="kpiTotalConvsSub"></div>
            </div>
            <div class="metric-card mc-blue">
                <div class="metric-label">CrÃ©ditos / ConversaciÃ³n <span class="info-icon" data-tooltip="Total crÃ©ditos VF Ã· total conversaciones. Promedio de crÃ©ditos consumidos por conversaciÃ³n completa.">i</span></div>
                <div class="metric-value" id="kpiCredPerConv">â€”</div>
                <div class="metric-sub" id="kpiCredPerConvSub"></div>
            </div>
            <div class="metric-card mc-orange">
                <div class="metric-label">Meses Restantes (Est.) <span class="info-icon" data-tooltip="CrÃ©ditos restantes Ã· burn rate mensual. Estima cuÃ¡ntos meses durarÃ¡ el saldo al ritmo actual.">i</span></div>
                <div class="metric-value" id="kpiMonthsLeft">â€”</div>
                <div class="metric-sub" id="kpiMonthsLeftSub"></div>
            </div>
        </div>

        <div class="two-col">
            <div class="chart-panel">
                <div class="chart-panel-header">
                    <div class="chart-panel-title">ğŸ“Š CrÃ©ditos Mensuales <span class="info-icon" data-tooltip="CrÃ©ditos del total VF distribuidos proporcionalmente segÃºn interacciones por mes.">i</span></div>
                </div>
                <div class="chart-wrap"><canvas id="chartMonthlyCredits"></canvas></div>
            </div>
            <div class="chart-panel">
                <div class="chart-panel-header">
                    <div class="chart-panel-title">ğŸ“ˆ Tendencia Diaria <span class="info-icon" data-tooltip="CrÃ©ditos estimados por dÃ­a con media mÃ³vil de 7 dÃ­as.">i</span></div>
                </div>
                <div class="chart-wrap"><canvas id="chartDailyTrend"></canvas></div>
            </div>
        </div>

        <div class="two-col">
            <div class="chart-panel">
                <div class="chart-panel-header">
                    <div class="chart-panel-title">ğŸ« CrÃ©ditos por Grado <span class="info-icon" data-tooltip="DistribuciÃ³n proporcional de crÃ©ditos VF por grado escolar.">i</span></div>
                </div>
                <div class="chart-wrap"><canvas id="chartByGrade"></canvas></div>
            </div>
            <div class="chart-panel">
                <div class="chart-panel-header">
                    <div class="chart-panel-title">ğŸ© ProporciÃ³n por Grado <span class="info-icon" data-tooltip="Porcentaje del total que consume cada grado.">i</span></div>
                </div>
                <div class="chart-wrap"><canvas id="chartGradeDist"></canvas></div>
            </div>
        </div>

        <div class="data-table-wrap">
            <div class="data-table-header">
                <div class="data-table-title">ğŸ“… Detalle Mensual</div>
            </div>
            <div style="overflow-x:auto">
                <table class="data-table" id="monthlyTable">
                    <thead><tr>
                        <th>Mes</th>
                        <th class="text-right">Interacciones</th>
                        <th class="text-right">Conversaciones</th>
                        <th class="text-right">Msgs/Conv</th>
                        <th class="text-right">CrÃ©ditos (Prop.)</th>
                        <th class="text-right">Costo (USD)</th>
                        <th>Tendencia</th>
                    </tr></thead>
                    <tbody id="monthlyTableBody">
                        <tr><td colspan="7" class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div class="empty-state-text">Haz clic en "Cargar Datos"</div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="insights-grid" id="insightsGrid"></div>

        <div class="data-table-wrap">
            <div class="data-table-header">
                <div class="data-table-title">ğŸ‘¤ Costo Estimado por Usuario <span class="info-icon" data-tooltip="Basado en: mÃ¡x 2 conv/semana, 48 semanas escolares. Usa crÃ©ditos/conversaciÃ³n real calibrados.">i</span></div>
            </div>
            <div style="overflow-x:auto">
                <table class="data-table" id="perUserTable">
                    <thead><tr>
                        <th>Grado</th>
                        <th class="text-right">CrÃ©d./Conv</th>
                        <th class="text-right">CrÃ©d./Semana</th>
                        <th class="text-right">CrÃ©d./Mes</th>
                        <th class="text-right">CrÃ©d./AÃ±o</th>
                        <th class="text-right">$/Semana</th>
                        <th class="text-right">$/Mes</th>
                        <th class="text-right">$/AÃ±o</th>
                    </tr></thead>
                    <tbody id="perUserTableBody"><tr><td colspan="8" style="text-align:center;color:var(--text-muted);padding:2rem">Sin datos</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- GRADE TABS -->
    <div class="tab-content" id="tab-grade-3"></div>
    <div class="tab-content" id="tab-grade-4"></div>
    <div class="tab-content" id="tab-grade-5"></div>
    <div class="tab-content" id="tab-grade-6"></div>
    <div class="tab-content" id="tab-grade-7"></div>
    <div class="tab-content" id="tab-grade-8"></div>
    <div class="tab-content" id="tab-grade-9"></div>
    <div class="tab-content" id="tab-grade-10"></div>
    <div class="tab-content" id="tab-grade-11"></div>
    <div class="tab-content" id="tab-grade-12"></div>

    <!-- PROJECTIONS TAB -->
    <div class="tab-content" id="tab-projections">
        <div class="projection-section">
            <div class="projection-title">ğŸ“‹ Resumen â€” ConfiguraciÃ³n Actual</div>
            <div class="metrics-row" id="projCurrentMetrics"></div>
            <div style="overflow-x:auto;margin-top:1rem">
                <table class="data-table" id="projCurrentTable">
                    <thead><tr>
                        <th>Grado</th>
                        <th class="text-right">CrÃ©d./Conv (real)</th>
                        <th class="text-right">Est. CrÃ©d./Usuario/AÃ±o</th>
                        <th class="text-right">Est. $/Usuario/AÃ±o</th>
                    </tr></thead>
                    <tbody id="projCurrentTableBody"><tr><td colspan="4" style="text-align:center;color:var(--text-muted);padding:2rem">Carga datos primero</td></tr></tbody>
                </table>
            </div>
        </div>

        <div class="projection-section">
            <div class="projection-title">ğŸ”¬ Simulador de Modelo Alternativo</div>
            <p style="color:var(--text-secondary);font-size:.82rem;margin-bottom:1rem;">
                Estima cuÃ¡nto costarÃ­a si cambiaras a un modelo diferente. Selecciona un modelo y el factor se aplica sobre los crÃ©ditos actuales considerando la diferencia de tasa por token.
            </p>
            <div class="sim-input-row">
                <div class="ctrl-group">
                    <label>Modelo a simular</label>
                    <select class="ctrl-select" id="simModelSelect"></select>
                </div>
                <div class="ctrl-group">
                    <label>Modelo base actual (referencia)</label>
                    <select class="ctrl-select" id="simBaseModelSelect"></select>
                </div>
                <button class="btn btn-primary" onclick="runSimulation()">âš¡ Simular</button>
            </div>
            <div id="simResults" style="margin-top:1.25rem;display:none;">
                <div class="data-table-wrap" style="margin-bottom:0">
                    <div class="data-table-header"><div class="data-table-title">Comparativa: Actual vs Simulado</div></div>
                    <div style="overflow-x:auto">
                        <table class="comparison-table" id="simCompTable">
                            <thead><tr>
                                <th>Grado</th>
                                <th>$/Usuario/AÃ±o (Actual)</th>
                                <th>$/Usuario/AÃ±o (Simulado)</th>
                                <th>Î” Ahorro/AÃ±o</th>
                            </tr></thead>
                            <tbody id="simCompTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="projection-section">
            <div class="projection-title">ğŸ“ Planificador de Capacidad</div>
            <p style="color:var(--text-secondary);font-size:.82rem;margin-bottom:1rem;">
                Ingresa usuarios totales y conversaciones/aÃ±o para estimar el costo total anual.
            </p>
            <div class="sim-input-row">
                <div class="ctrl-group">
                    <label>Usuarios Totales</label>
                    <input type="number" class="ctrl-input" id="capGlobalUsers" value="100" min="1" style="width:100px">
                </div>
                <div class="ctrl-group">
                    <label>Conv./AÃ±o por Usuario</label>
                    <input type="number" class="ctrl-input" id="capConvsYear" value="80" min="1" style="width:100px">
                    <span style="font-size:.65rem;color:var(--text-muted)">MÃ¡x ~96 (2/sem Ã— 48 sem)</span>
                </div>
                <button class="btn btn-success" onclick="runCapacity()">ğŸ“Š Calcular</button>
            </div>
            <div id="capResults" style="display:none">
                <div class="metrics-row" id="capMetrics"></div>
                <div style="overflow-x:auto;margin-top:1rem">
                    <table class="comparison-table" id="capTable">
                        <thead><tr>
                            <th>Grado</th>
                            <th class="text-right">Usuarios</th>
                            <th class="text-right">CrÃ©ditos/AÃ±o</th>
                            <th class="text-right">Costo/AÃ±o (USD)</th>
                        </tr></thead>
                        <tbody id="capTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIGURATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PROXY_URL = "https://voiceflow-analytics.chat-gpt-bc7.workers.dev";

const MAX_CONVS_PER_WEEK = 2;
const WEEKS_PER_YEAR = 48;
const MAX_CONVS_PER_YEAR = MAX_CONVS_PER_WEEK * WEEKS_PER_YEAR;

const PROJECTS = [
    { name:"Xolo 2.0 - 3", grade:3, id:"69648a3142fb1cac823bd719", key:"VF.DM.69648b19774372ae83b64a6f.Gxyvv88zdFVvrfhL" },
    { name:"Xolo 2.0 - 4", grade:4, id:"696467d942fb1cac823bd1e3", key:"VF.DM.696485c0aeb01b0b69b6a670.GW6aEdVYlOCsmKgi" },
    { name:"Xolo 2.0 - 5", grade:5, id:"696467a542fb1cac823bd1d7", key:"VF.DM.6964854eb6139e75b888f46d.xdHG0G0Nuyvkinz5" },
    { name:"Xolo 2.0 - 6", grade:6, id:"696467c442fb1cac823bd1de", key:"VF.DM.6964842142cf44d88c7bc011.A7CKjUYFqJBBzz9I" },
    { name:"Xolo 2.0 - 7", grade:7, id:"69648b3442fb1cac823bd724", key:"VF.DM.69649147b6139e75b888f470.VxjRlJ1aUQQ0XSmW" },
    { name:"Xolo 2.0 - 8", grade:8, id:"6964915b42fb1cac823bd760", key:"VF.DM.696492ee3de508144d819027.li2BDyTMZLRxqJMf" },
    { name:"Xolo 2.0 - 9", grade:9, id:"69648b5842fb1cac823bd729", key:"VF.DM.69648e9ab6139e75b888f46e.NS8oW3YkgnPW7Fqm" },
    { name:"Xolo 2.0 - 10", grade:10, id:"6964931942fb1cac823bd788", key:"VF.DM.69649443b6139e75b888f471.OztVLPOnLPZbPdTz" },
    { name:"Xolo 2.0 - 11", grade:11, id:"6964947942fb1cac823bd7a6", key:"VF.DM.696494d7fbbabc183d666b77.bsj9cKB680jegVI2" },
    { name:"Xolo 2.0 - 12", grade:12, id:"6964948942fb1cac823bd7ab", key:"VF.DM.6964952daeb01b0b69b6a672.axrKSvL4BDs6LUgO" }
];

// Credits per 1K tokens for model comparison
const MODEL_PRICING = {
    "claude-3.5-haiku":   { vendor:"Anthropic", out:1, in:0.2 },
    "claude-4.5-haiku":   { vendor:"Anthropic", out:1.25, in:0.25 },
    "claude-4.5-opus":    { vendor:"Anthropic", out:6.25, in:1.25 },
    "claude-4-opus":      { vendor:"Anthropic", out:18.75, in:3.75 },
    "claude-4-sonnet":    { vendor:"Anthropic", out:3.75, in:0.75 },
    "claude-4.5-sonnet":  { vendor:"Anthropic", out:3.75, in:0.75 },
    "gemini-2.0-flash":   { vendor:"Google", out:0.1, in:0.025 },
    "gemini-2.5-flash":   { vendor:"Google", out:0.625, in:0.075 },
    "gemini-2.5-pro":     { vendor:"Google", out:2.5, in:0.3125 },
    "llama-3.1-8b":       { vendor:"Groq", out:0.02, in:0.0125 },
    "llama-3.3-70b":      { vendor:"Groq", out:0.1975, in:0.1475 },
    "gpt-4o":             { vendor:"OpenAI", out:2.5, in:0.625 },
    "gpt-4o-mini":        { vendor:"OpenAI", out:0.15, in:0.0375 },
    "gpt-4.1":            { vendor:"OpenAI", out:2, in:0.5 },
    "gpt-4.1-mini":       { vendor:"OpenAI", out:0.4, in:0.1 },
    "gpt-4.1-nano":       { vendor:"OpenAI", out:0.1, in:0.025 },
    "gpt-5":              { vendor:"OpenAI", out:2.5, in:0.3125 },
    "gpt-5-mini":         { vendor:"OpenAI", out:0.5, in:0.0625 },
    "o3-mini":            { vendor:"OpenAI", out:1.1, in:0.275 },
    "o4-mini":            { vendor:"OpenAI", out:1.1, in:0.275 },
};

// Estimated credits per message for each model (LLM only, ~500 input tokens, ~350 output tokens)
const AVG_IN_K = 0.5, AVG_OUT_K = 0.35;
const MODEL_CRED_PER_MSG = {};
Object.entries(MODEL_PRICING).forEach(([k, m]) => {
    MODEL_CRED_PER_MSG[k] = (m.in * AVG_IN_K) + (m.out * AVG_OUT_K);
});

const GRADE_COLORS = ['#6366f1','#8b5cf6','#a855f7','#c084fc','#34d399','#10b981','#06b6d4','#3b82f6','#f59e0b','#f97316'];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let STATE = {
    rawData: [],
    activeTab: "dashboard",
    activeUnit: "credits",
    charts: {},
    loaded: false,
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALIBRATION HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getVFCredits() { return parseFloat(document.getElementById('vfReportedCredits').value) || 0; }
function getPlanTotal() { return parseFloat(document.getElementById('planTotalCredits').value) || 2400000; }
function getPlanCost()  { return parseFloat(document.getElementById('planCostUSD').value) || 10800; }
function getCreditToUSD() { return getPlanCost() / getPlanTotal(); }

function getTotalInteractions() {
    return STATE.rawData.reduce((s, p) => s + p.interactions, 0);
}

/** Real credits per interaction (calibrated) */
function getCredPerInteraction() {
    const totalInt = getTotalInteractions();
    return totalInt > 0 ? getVFCredits() / totalInt : 0;
}

/** Distribute VF credits proportionally to a project based on its interactions */
function getProjectCredits(proj) {
    const totalInt = getTotalInteractions();
    if (totalInt === 0) return 0;
    return (proj.interactions / totalInt) * getVFCredits();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('endDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = '2025-01-05';

    // Populate sim model selects
    const modelOpts = Object.keys(MODEL_PRICING).map(k =>
        `<option value="${k}">${k} (${MODEL_CRED_PER_MSG[k].toFixed(3)} crÃ©d/msg)</option>`
    ).join('');
    document.getElementById('simModelSelect').innerHTML = modelOpts;
    document.getElementById('simBaseModelSelect').innerHTML = modelOpts;
    document.getElementById('simBaseModelSelect').value = 'claude-4.5-haiku';

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });

    document.querySelectorAll('#unitToggle .toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('#unitToggle .toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            STATE.activeUnit = btn.dataset.unit;
            if (STATE.loaded) renderAll();
        });
    });

    document.getElementById('periodPreset').addEventListener('change', handlePeriodChange);
    hideLoading();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function switchTab(tabId) {
    STATE.activeTab = tabId;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === `tab-${tabId}`));
    if (tabId.startsWith('grade-') && STATE.loaded) {
        renderGradeTab(parseInt(tabId.split('-')[1]));
    }
}

function handlePeriodChange() {
    const val = document.getElementById('periodPreset').value;
    const today = new Date();
    document.getElementById('customDateStart').style.display = val === 'custom' ? '' : 'none';
    document.getElementById('customDateEnd').style.display = val === 'custom' ? '' : 'none';
    if (val === 'custom') return;

    let start;
    switch(val) {
        case 'this_month': start = new Date(today.getFullYear(), today.getMonth(), 1); break;
        case 'last_month':
            start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            document.getElementById('endDate').value = new Date(today.getFullYear(), today.getMonth(), 0).toISOString().split('T')[0];
            document.getElementById('startDate').value = start.toISOString().split('T')[0];
            return;
        case 'last_3': start = new Date(today.getFullYear(), today.getMonth() - 3, 1); break;
        case 'last_6': start = new Date(today.getFullYear(), today.getMonth() - 6, 1); break;
        case 'all': start = new Date('2025-01-05'); break;
    }
    document.getElementById('startDate').value = start.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API FETCHING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchAllPages(project, queryName, startTime, endTime) {
    let allItems = [], cursor = null, hasMore = true, pages = 0;
    while (hasMore && pages < 50) {
        const body = { data: { name: queryName, filter: { projectID: project.id, startTime, endTime, limit: 500 } } };
        if (cursor) body.data.filter.cursor = cursor;

        let resp;
        try {
            resp = await fetch(`${PROXY_URL}/v2/query/usage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': project.key },
                body: JSON.stringify(body)
            });
        } catch (networkErr) {
            throw new Error(`Red: ${networkErr.message} (${queryName})`);
        }

        if (!resp.ok) {
            const text = await resp.text().catch(() => '');
            throw new Error(`HTTP ${resp.status} en ${queryName}: ${text.substring(0, 200)}`);
        }

        const data = await resp.json();
        if (data.result && data.result.items) {
            allItems = allItems.concat(data.result.items);
            cursor = data.result.cursor;
            hasMore = !!cursor && data.result.items.length > 0;
        } else {
            hasMore = false;
        }
        pages++;
    }
    return allItems;
}

async function fetchProjectData(project, startTime, endTime) {
    try {
        const [interactionsData, usersData, tokenData] = await Promise.all([
            fetchAllPages(project, 'interactions', startTime, endTime),
            fetchAllPages(project, 'unique_users', startTime, endTime),
            fetchAllPages(project, 'token_usage', startTime, endTime).catch(() => []),
        ]);

        const dailyStats = {};
        interactionsData.forEach(item => {
            const day = item.period.split('T')[0];
            if (!dailyStats[day]) dailyStats[day] = { interactions: 0, users: 0, tokens: 0 };
            dailyStats[day].interactions += item.count;
        });
        usersData.forEach(item => {
            const day = item.period.split('T')[0];
            if (!dailyStats[day]) dailyStats[day] = { interactions: 0, users: 0, tokens: 0 };
            dailyStats[day].users += item.count;
        });
        tokenData.forEach(item => {
            const day = item.period.split('T')[0];
            if (!dailyStats[day]) dailyStats[day] = { interactions: 0, users: 0, tokens: 0 };
            dailyStats[day].tokens += item.count;
        });

        const totalInteractions = interactionsData.reduce((s, i) => s + i.count, 0);
        const totalUsers = usersData.reduce((s, i) => s + i.count, 0);
        const totalTokens = tokenData.reduce((s, i) => s + i.count, 0);

        return {
            project: project.name, grade: project.grade, projectId: project.id,
            interactions: totalInteractions, users: totalUsers, tokens: totalTokens,
            average: totalUsers > 0 ? totalInteractions / totalUsers : 0,
            dailyStats,
        };
    } catch (err) {
        console.error(`Fetch error (${project.name}):`, err);
        return {
            project: project.name, grade: project.grade, projectId: project.id,
            interactions: 0, users: 0, tokens: 0, average: 0, dailyStats: {}, error: err.message
        };
    }
}

async function fetchAllData() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    if (!startDate || !endDate) { alert('Selecciona fechas'); return; }

    const startTime = new Date(startDate).toISOString();
    const endTime = new Date(endDate + 'T23:59:59').toISOString();

    showLoading();
    setStatus('loading', 'Cargando...');

    try {
        const results = [];
        for (let i = 0; i < PROJECTS.length; i++) {
            updateLoadingProgress(`Proyecto ${i+1}/${PROJECTS.length}: ${PROJECTS[i].name}`);
            results.push(await fetchProjectData(PROJECTS[i], startTime, endTime));
        }

        const errors = results.filter(r => r.error);
        if (errors.length > 0) {
            console.warn(`${errors.length} proyectos con error:`, errors.map(e => `${e.project}: ${e.error}`));
        }

        STATE.rawData = results;
        STATE.loaded = true;

        const totalTokens = results.reduce((s, r) => s + (r.tokens || 0), 0);
        const totalInteractions = results.reduce((s, r) => s + r.interactions, 0);
        const totalUsers = results.reduce((s, r) => s + r.users, 0);
        const tokensPerInt = totalInteractions > 0 ? (totalTokens / totalInteractions).toFixed(0) : '?';

        console.log(`ğŸ“Š Resumen: ${totalInteractions} interacciones, ${totalUsers} conversaciones, ${totalTokens} tokens (${tokensPerInt} tokens/int)`);

        setStatus(errors.length > 0 ? 'warning' : '', errors.length > 0 ? `${errors.length} errores` : 'Datos cargados');
        renderAll();
    } catch (err) {
        console.error('Fetch error:', err, JSON.stringify(err));
        setStatus('error', 'Error');
        alert('Error al cargar datos: ' + (err.message || String(err)));
    } finally {
        hideLoading();
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AGGREGATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function aggregateDaily(grade = null) {
    const daily = {};
    STATE.rawData.forEach(proj => {
        if (grade !== null && proj.grade !== grade) return;
        Object.entries(proj.dailyStats).forEach(([day, s]) => {
            if (!daily[day]) daily[day] = { interactions: 0, users: 0, tokens: 0 };
            daily[day].interactions += s.interactions;
            daily[day].users += s.users;
            daily[day].tokens += (s.tokens || 0);
        });
    });
    return daily;
}

function aggregateMonthly(grade = null) {
    const daily = aggregateDaily(grade);
    const monthly = {};
    Object.entries(daily).forEach(([day, s]) => {
        const m = day.substring(0, 7);
        if (!monthly[m]) monthly[m] = { interactions: 0, users: 0, tokens: 0 };
        monthly[m].interactions += s.interactions;
        monthly[m].users += s.users;
        monthly[m].tokens += (s.tokens || 0);
    });
    return monthly;
}

function getTotals(grade = null) {
    let interactions = 0, users = 0, tokens = 0;
    STATE.rawData.forEach(p => {
        if (grade !== null && p.grade !== grade) return;
        interactions += p.interactions;
        users += p.users;
        tokens += (p.tokens || 0);
    });
    return { interactions, users, tokens, average: users > 0 ? interactions / users : 0 };
}

function formatVal(credits) {
    if (STATE.activeUnit === 'cost') return '$' + fmtNum(credits * getCreditToUSD(), 2);
    return fmtNum(credits);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER ALL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAll() {
    renderGlobalMetrics();
    renderMonthlyTable();
    renderCharts();
    renderInsights();
    renderPerUserTable();
    renderProjectionsCurrent();

    if (STATE.activeTab.startsWith('grade-')) {
        renderGradeTab(parseInt(STATE.activeTab.split('-')[1]));
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBAL METRICS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderGlobalMetrics() {
    const totals = getTotals();
    const vfCredits = getVFCredits();
    const planTotal = getPlanTotal();
    const creditToUSD = getCreditToUSD();
    const remaining = planTotal - vfCredits;
    const pctUsed = planTotal > 0 ? (vfCredits / planTotal * 100) : 0;
    const credPerInt = getCredPerInteraction();

    const monthly = aggregateMonthly();
    const months = Object.keys(monthly);
    const numMonths = months.length;
    const avgBurn = numMonths > 0 ? vfCredits / numMonths : 0;
    const monthsLeft = avgBurn > 0 ? remaining / avgBurn : Infinity;
    const credPerConv = totals.users > 0 ? vfCredits / totals.users : 0;

    const set = (id, val, sub) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
        const s = document.getElementById(id + 'Sub');
        if (s && sub) s.textContent = sub;
    };

    set('kpiTotalCredits', formatVal(vfCredits), `${pctUsed.toFixed(1)}% del plan utilizado`);
    set('kpiRemaining', formatVal(remaining), remaining < 0 ? 'âš ï¸ Plan excedido' : `${(100 - pctUsed).toFixed(1)}% disponible`);
    set('kpiCredPerInt', fmtNum(credPerInt, 2), `crÃ©ditos promedio por interacciÃ³n`);
    set('kpiBurnRate', formatVal(avgBurn), `promedio mensual (crÃ©ditos)`);
    set('kpiTotalMsgs', fmtNum(totals.interactions), `interacciones totales`);
    set('kpiTotalConvs', fmtNum(totals.users), `conversaciones Ãºnicas`);
    set('kpiCredPerConv', fmtNum(credPerConv, 1), `crÃ©ditos/conversaciÃ³n promedio`);
    set('kpiMonthsLeft', monthsLeft === Infinity ? 'âˆ' : fmtNum(monthsLeft, 1), avgBurn > 0 ? `al ritmo de ${fmtNum(avgBurn, 0)} crÃ©d/mes` : '');

    // Token info
    if (totals.tokens > 0) {
        set('kpiTokensTotal', fmtNum(totals.tokens), `${totals.interactions > 0 ? fmtNum(totals.tokens / totals.interactions, 0) : '?'} tokens/interacciÃ³n`);
    }

    const remEl = document.getElementById('kpiRemaining');
    if (remEl) remEl.style.color = remaining < 0 ? 'var(--accent-rose)' : remaining < 200000 ? 'var(--accent-amber)' : 'var(--accent-emerald)';
    const mlEl = document.getElementById('kpiMonthsLeft');
    if (mlEl) mlEl.style.color = monthsLeft < 2 ? 'var(--accent-rose)' : monthsLeft < 6 ? 'var(--accent-amber)' : 'var(--accent-orange)';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MONTHLY TABLE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderMonthlyTable() {
    const monthly = aggregateMonthly();
    const months = Object.keys(monthly).sort();
    const tbody = document.getElementById('monthlyTableBody');
    const totalInt = getTotalInteractions();
    const vfCredits = getVFCredits();
    const creditToUSD = getCreditToUSD();
    const totals = getTotals();
    const hasTokens = totals.tokens > 0;

    if (months.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-muted);padding:2rem">Sin datos</td></tr>';
        return;
    }

    let prevCredits = null;
    tbody.innerHTML = months.map(month => {
        const d = monthly[month];
        const credits = totalInt > 0 ? (d.interactions / totalInt) * vfCredits : 0;
        const cost = credits * creditToUSD;
        const msgsPerConv = d.users > 0 ? (d.interactions / d.users).toFixed(1) : '0';
        const tokensCol = hasTokens ? `<td class="mono text-right" style="color:var(--accent-cyan)">${fmtNum(d.tokens || 0)}</td>` : '';

        let trend = 'â€”';
        if (prevCredits !== null) {
            const diff = credits - prevCredits;
            const pct = prevCredits > 0 ? (diff / prevCredits * 100).toFixed(1) : 0;
            trend = diff > 0 ? `<span class="metric-trend up">â†‘ +${pct}%</span>` :
                    diff < 0 ? `<span class="metric-trend down">â†“ ${pct}%</span>` :
                    `<span style="color:var(--text-muted)">= 0%</span>`;
        }
        prevCredits = credits;

        const monthName = new Date(month + '-01').toLocaleDateString('es-MX', { year:'numeric', month:'long' });
        return `<tr>
            <td>${monthName}</td>
            <td class="mono text-right">${fmtNum(d.interactions)}</td>
            <td class="mono text-right">${fmtNum(d.users)}</td>
            <td class="mono text-right">${msgsPerConv}</td>
            ${tokensCol}
            <td class="mono text-right" style="color:var(--accent-indigo)">${fmtNum(credits, 0)}</td>
            <td class="mono text-right" style="color:var(--accent-emerald)">$${fmtNum(cost, 2)}</td>
            <td>${trend}</td>
        </tr>`;
    }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function destroyChart(key) { if (STATE.charts[key]) { STATE.charts[key].destroy(); delete STATE.charts[key]; } }

const CHART_DEFAULTS = {
    responsive: true, maintainAspectRatio: false,
    plugins: {
        legend: { labels: { color: '#8892a8', font: { family: "'DM Sans'", size: 11 }, boxWidth: 12, padding: 12 } },
        tooltip: { backgroundColor: '#1a2236', borderColor: '#2a3550', borderWidth: 1, titleColor: '#e8ecf4', bodyColor: '#8892a8', titleFont: { family: "'DM Sans'", weight: 'bold' }, bodyFont: { family: "'JetBrains Mono'", size: 11 }, padding: 10, cornerRadius: 8 }
    },
    scales: {
        x: { ticks: { color: '#5a6478', font: { family: "'DM Sans'", size: 10 } }, grid: { color: 'rgba(42,53,80,.3)' } },
        y: { ticks: { color: '#5a6478', font: { family: "'JetBrains Mono'", size: 10 } }, grid: { color: 'rgba(42,53,80,.3)' } }
    }
};

function renderCharts() {
    if (typeof Chart === 'undefined') {
        console.error('Chart.js no cargÃ³. Intentando cargar de forma alternativa...');
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js';
        script.onload = () => { console.log('Chart.js cargado (fallback)'); renderCharts(); };
        script.onerror = () => console.error('Chart.js no se pudo cargar de ningÃºn CDN.');
        document.head.appendChild(script);
        return;
    }
    try { renderChartMonthlyCredits(); } catch(e) { console.error('Chart monthly error:', e); }
    try { renderChartDailyTrend(); } catch(e) { console.error('Chart daily error:', e); }
    try { renderChartByGrade(); } catch(e) { console.error('Chart grade error:', e); }
    try { renderChartGradeDist(); } catch(e) { console.error('Chart dist error:', e); }
}

function renderChartMonthlyCredits() {
    destroyChart('monthlyCredits');
    const monthly = aggregateMonthly();
    const months = Object.keys(monthly).sort();
    if (months.length === 0) return;
    const totalInt = getTotalInteractions();
    const vfCredits = getVFCredits();

    const ctx = document.getElementById('chartMonthlyCredits').getContext('2d');
    STATE.charts.monthlyCredits = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: months.map(m => new Date(m + '-01').toLocaleDateString('es-MX', { month: 'short', year: '2-digit' })),
            datasets: [{
                label: 'CrÃ©ditos',
                data: months.map(m => totalInt > 0 ? (monthly[m].interactions / totalInt) * vfCredits : 0),
                backgroundColor: '#6366f1cc', borderColor: '#6366f1', borderWidth: 1,
            }]
        },
        options: { ...CHART_DEFAULTS, plugins: { ...CHART_DEFAULTS.plugins, legend: { display: false } } }
    });
}

function renderChartDailyTrend() {
    destroyChart('dailyTrend');
    const daily = aggregateDaily();
    const days = Object.keys(daily).sort();
    if (days.length === 0) return;
    const totalInt = getTotalInteractions();
    const vfCredits = getVFCredits();
    const credPerInt = totalInt > 0 ? vfCredits / totalInt : 0;

    const values = days.map(d => daily[d].interactions * credPerInt);
    const ma7 = values.map((_, i) => {
        const sl = values.slice(Math.max(0, i - 6), i + 1);
        return sl.reduce((a, b) => a + b, 0) / sl.length;
    });

    const ctx = document.getElementById('chartDailyTrend').getContext('2d');
    STATE.charts.dailyTrend = new Chart(ctx, {
        type: 'line',
        data: {
            labels: days.map(d => new Date(d).toLocaleDateString('es-MX', { day: '2-digit', month: 'short' })),
            datasets: [
                { label: 'CrÃ©ditos/dÃ­a', data: values, borderColor: '#6366f180', backgroundColor: '#6366f115', fill: true, tension: 0.3, pointRadius: 1, borderWidth: 1.5 },
                { label: 'Media mÃ³vil 7d', data: ma7, borderColor: '#f59e0b', backgroundColor: 'transparent', borderWidth: 2, pointRadius: 0, tension: 0.4, borderDash: [5, 3] }
            ]
        },
        options: CHART_DEFAULTS
    });
}

function renderChartByGrade() {
    destroyChart('byGrade');
    const totalInt = getTotalInteractions();
    const vfCredits = getVFCredits();
    const labels = [], data = [];
    PROJECTS.forEach((p, i) => {
        const proj = STATE.rawData.find(r => r.grade === p.grade);
        if (!proj) return;
        labels.push(`${p.grade}Â°`);
        data.push(totalInt > 0 ? (proj.interactions / totalInt) * vfCredits : 0);
    });

    const ctx = document.getElementById('chartByGrade').getContext('2d');
    STATE.charts.byGrade = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'CrÃ©ditos', data, backgroundColor: GRADE_COLORS.map(c => c + 'cc'), borderColor: GRADE_COLORS, borderWidth: 1 }] },
        options: { ...CHART_DEFAULTS, plugins: { ...CHART_DEFAULTS.plugins, legend: { display: false } } }
    });
}

function renderChartGradeDist() {
    destroyChart('gradeDist');
    const totalInt = getTotalInteractions();
    const vfCredits = getVFCredits();
    const labels = [], data = [];
    PROJECTS.forEach((p, i) => {
        const proj = STATE.rawData.find(r => r.grade === p.grade);
        if (!proj || proj.interactions === 0) return;
        labels.push(`Grado ${p.grade}Â°`);
        data.push(totalInt > 0 ? (proj.interactions / totalInt) * vfCredits : 0);
    });

    const ctx = document.getElementById('chartGradeDist').getContext('2d');
    STATE.charts.gradeDist = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data, backgroundColor: GRADE_COLORS, borderColor: '#1a2236', borderWidth: 2 }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: { color: '#8892a8', font: { family: "'DM Sans'", size: 11 }, padding: 10, boxWidth: 12 } },
                tooltip: { ...CHART_DEFAULTS.plugins.tooltip, callbacks: { label: ctx => { const pct = (ctx.raw / data.reduce((a,b)=>a+b,0) * 100).toFixed(1); return `${ctx.label}: ${fmtNum(ctx.raw,0)} crÃ©d (${pct}%)`; } } }
            }
        }
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INSIGHTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderInsights() {
    const totals = getTotals();
    const vfCredits = getVFCredits();
    const planTotal = getPlanTotal();
    const remaining = planTotal - vfCredits;
    const creditToUSD = getCreditToUSD();
    const credPerInt = getCredPerInteraction();

    const monthly = aggregateMonthly();
    const months = Object.keys(monthly).sort();
    const numMonths = months.length;
    const avgBurn = numMonths > 0 ? vfCredits / numMonths : 0;

    let peakMonth = '', peakInt = 0;
    months.forEach(m => { if (monthly[m].interactions > peakInt) { peakInt = monthly[m].interactions; peakMonth = m; } });
    const peakCredits = getTotalInteractions() > 0 ? (peakInt / getTotalInteractions()) * vfCredits : 0;

    let topGrade = null, topGradeCredits = 0;
    STATE.rawData.forEach(p => {
        const c = getProjectCredits(p);
        if (c > topGradeCredits) { topGradeCredits = c; topGrade = p; }
    });

    const dailyCredits = aggregateDaily();
    const totalDays = Object.keys(dailyCredits).length;
    const avgDailyCredits = totalDays > 0 ? vfCredits / totalDays : 0;
    const projAnnual = avgDailyCredits * 365;

    const credPerConv = totals.users > 0 ? vfCredits / totals.users : 0;

    const grid = document.getElementById('insightsGrid');
    grid.innerHTML = `
    <div class="insight-card">
        <div class="insight-card-header"><div class="insight-icon" style="background:rgba(244,63,94,.15)">âš ï¸</div><div class="insight-card-title">Estado del Plan</div></div>
        <div class="insight-card-body">
            Se han consumido <strong>${fmtNum(vfCredits,0)}</strong> crÃ©ditos (${(vfCredits/planTotal*100).toFixed(1)}% del plan).
            Quedan <strong>${fmtNum(Math.max(0,remaining),0)}</strong> crÃ©ditos.
            ${remaining < 0 ? '<br><span class="badge badge-danger">PLAN EXCEDIDO</span>' :
              remaining < 200000 ? '<br><span class="badge badge-warning">CrÃ©ditos bajos</span>' :
              '<br><span class="badge badge-success">Dentro del plan</span>'}
        </div>
    </div>
    <div class="insight-card">
        <div class="insight-card-header"><div class="insight-icon" style="background:rgba(99,102,241,.15)">ğŸ“ˆ</div><div class="insight-card-title">ProyecciÃ³n Anual</div></div>
        <div class="insight-card-body">
            Al ritmo actual de <strong>${fmtNum(avgDailyCredits,0)}</strong> crÃ©ditos/dÃ­a,
            se proyectan <strong>${fmtNum(projAnnual,0)}</strong> crÃ©ditos anuales
            (<strong>$${fmtNum(projAnnual * creditToUSD,2)}</strong> USD).
            ${projAnnual > planTotal ? `<br>Excede el plan por <strong>${fmtNum(projAnnual - planTotal,0)}</strong> crÃ©ditos.` : `<br>Dentro del plan (${(projAnnual/planTotal*100).toFixed(1)}%).`}
        </div>
    </div>
    <div class="insight-card">
        <div class="insight-card-header"><div class="insight-icon" style="background:rgba(245,158,11,.15)">ğŸ”¥</div><div class="insight-card-title">Mes Pico</div></div>
        <div class="insight-card-body">
            El mes con mayor consumo fue <strong>${peakMonth ? new Date(peakMonth+'-01').toLocaleDateString('es-MX',{month:'long',year:'numeric'}) : 'N/A'}</strong>
            con ~<strong>${fmtNum(peakCredits,0)}</strong> crÃ©ditos ($${fmtNum(peakCredits*creditToUSD,2)}).
        </div>
    </div>
    <div class="insight-card">
        <div class="insight-card-header"><div class="insight-icon" style="background:rgba(16,185,129,.15)">ğŸ«</div><div class="insight-card-title">Grado con Mayor Uso</div></div>
        <div class="insight-card-body">
            <strong>${topGrade ? topGrade.project : 'N/A'}</strong>: ~<strong>${fmtNum(topGradeCredits,0)}</strong> crÃ©ditos
            (${topGrade ? fmtNum(topGrade.interactions) : 0} interacciones, ${topGrade ? fmtNum(topGrade.users) : 0} conversaciones).
        </div>
    </div>
    <div class="insight-card">
        <div class="insight-card-header"><div class="insight-icon" style="background:rgba(6,182,212,.15)">ğŸ’¡</div><div class="insight-card-title">Eficiencia por InteracciÃ³n</div></div>
        <div class="insight-card-body">
            Promedio real: <strong>${credPerInt.toFixed(2)}</strong> crÃ©ditos/interacciÃ³n.
            Cada conversaciÃ³n de <strong>${totals.average.toFixed(0)}</strong> msgs cuesta ~<strong>${fmtNum(credPerConv,1)}</strong> crÃ©ditos ($${fmtNum(credPerConv * creditToUSD,4)}).
            <br>Esto refleja todas las llamadas LLM: orquestaciÃ³n, prompts, KB queries y agent steps.
        </div>
    </div>
    <div class="insight-card">
        <div class="insight-card-header"><div class="insight-icon" style="background:rgba(139,92,246,.15)">â±ï¸</div><div class="insight-card-title">Volatilidad</div></div>
        <div class="insight-card-body">
            ${numMonths >= 2 ? (() => {
                const monthCreds = months.map(m => (monthly[m].interactions / getTotalInteractions()) * vfCredits);
                const avg = monthCreds.reduce((a,b)=>a+b,0) / monthCreds.length;
                const stdev = Math.sqrt(monthCreds.reduce((s,v) => s + Math.pow(v - avg, 2), 0) / monthCreds.length);
                const cv = avg > 0 ? (stdev / avg * 100).toFixed(1) : 0;
                return `Variabilidad mensual: <strong>${cv}%</strong> (Ïƒ=${fmtNum(stdev,0)}).
                    ${cv > 50 ? '<br>Alta volatilidad â€” cambios de modelo durante experimentaciÃ³n.' :
                     cv > 25 ? '<br>Moderada â€” estabilizÃ¡ndose.' : '<br>Baja â€” uso consistente.'}`;
            })() : 'Datos insuficientes.'}
        </div>
    </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PER USER TABLE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderPerUserTable() {
    const tbody = document.getElementById('perUserTableBody');
    const creditToUSD = getCreditToUSD();
    const totalInt = getTotalInteractions();
    const vfCredits = getVFCredits();

    const rows = PROJECTS.map(p => {
        const proj = STATE.rawData.find(r => r.grade === p.grade);
        if (!proj || proj.users === 0) return null;

        const projCredits = getProjectCredits(proj);
        const credPerConv = projCredits / proj.users;
        const credPerWeek = credPerConv * MAX_CONVS_PER_WEEK;
        const credPerMonth = credPerWeek * 4.33;
        const credPerYear = credPerConv * MAX_CONVS_PER_YEAR;

        return `<tr>
            <td><strong>${p.grade}Â°</strong></td>
            <td class="mono text-right">${fmtNum(credPerConv,1)}</td>
            <td class="mono text-right">${fmtNum(credPerWeek,1)}</td>
            <td class="mono text-right">${fmtNum(credPerMonth,0)}</td>
            <td class="mono text-right">${fmtNum(credPerYear,0)}</td>
            <td class="mono text-right" style="color:var(--accent-emerald)">$${fmtNum(credPerWeek*creditToUSD,3)}</td>
            <td class="mono text-right" style="color:var(--accent-emerald)">$${fmtNum(credPerMonth*creditToUSD,2)}</td>
            <td class="mono text-right" style="color:var(--accent-amber)">$${fmtNum(credPerYear*creditToUSD,2)}</td>
        </tr>`;
    }).filter(Boolean);

    tbody.innerHTML = rows.length > 0 ? rows.join('') : '<tr><td colspan="8" style="text-align:center;color:var(--text-muted);padding:2rem">Sin datos</td></tr>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GRADE TAB
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderGradeTab(grade) {
    const container = document.getElementById(`tab-grade-${grade}`);
    const proj = STATE.rawData.find(r => r.grade === grade);

    if (!proj || proj.interactions === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div class="empty-state-text">No hay datos para grado ${grade}Â°</div></div>`;
        return;
    }

    const projCredits = getProjectCredits(proj);
    const creditToUSD = getCreditToUSD();
    const credPerConv = proj.users > 0 ? projCredits / proj.users : 0;
    const credPerInt = proj.interactions > 0 ? projCredits / proj.interactions : 0;

    const daily = proj.dailyStats;
    const days = Object.keys(daily).sort();
    const monthly = {};
    days.forEach(d => {
        const m = d.substring(0, 7);
        if (!monthly[m]) monthly[m] = { interactions: 0, users: 0 };
        monthly[m].interactions += daily[d].interactions;
        monthly[m].users += daily[d].users;
    });

    const cId = `chartG${grade}`;
    const yearlyPerUser = credPerConv * MAX_CONVS_PER_YEAR;

    container.innerHTML = `
    <div class="metrics-row">
        <div class="metric-card mc-indigo">
            <div class="metric-label">Total CrÃ©ditos <span class="info-icon" data-tooltip="${proj.interactions} interacciones Ã— (${fmtNum(projCredits,0)} Ã· ${proj.interactions}) = ${fmtNum(projCredits,0)} crÃ©ditos proporcionales del total VF.">i</span></div>
            <div class="metric-value">${formatVal(projCredits)}</div>
        </div>
        <div class="metric-card mc-cyan">
            <div class="metric-label">Interacciones</div>
            <div class="metric-value">${fmtNum(proj.interactions)}</div>
        </div>
        <div class="metric-card mc-emerald">
            <div class="metric-label">Conversaciones</div>
            <div class="metric-value">${fmtNum(proj.users)}</div>
        </div>
        <div class="metric-card mc-amber">
            <div class="metric-label">CrÃ©d./Conv <span class="info-icon" data-tooltip="${fmtNum(projCredits,0)} crÃ©ditos Ã· ${proj.users} conversaciones">i</span></div>
            <div class="metric-value">${fmtNum(credPerConv, 1)}</div>
        </div>
        <div class="metric-card mc-violet">
            <div class="metric-label">Msgs/Conv</div>
            <div class="metric-value">${proj.average.toFixed(1)}</div>
        </div>
        <div class="metric-card mc-orange">
            <div class="metric-label">Costo Total</div>
            <div class="metric-value" style="color:var(--accent-emerald)">$${fmtNum(projCredits * creditToUSD, 2)}</div>
        </div>
    </div>

    <div class="two-col">
        <div class="chart-panel">
            <div class="chart-panel-title">ğŸ“ˆ CrÃ©ditos Diarios â€” ${grade}Â°</div>
            <div class="chart-wrap"><canvas id="${cId}Daily"></canvas></div>
        </div>
        <div class="chart-panel">
            <div class="chart-panel-title">ğŸ“Š CrÃ©ditos Mensuales â€” ${grade}Â°</div>
            <div class="chart-wrap"><canvas id="${cId}Monthly"></canvas></div>
        </div>
    </div>

    <div class="data-table-wrap">
        <div class="data-table-header"><div class="data-table-title">ğŸ“… Detalle â€” ${grade}Â°</div></div>
        <div style="overflow-x:auto"><table class="data-table">
            <thead><tr><th>Mes</th><th class="text-right">Msgs</th><th class="text-right">Conv</th><th class="text-right">CrÃ©ditos</th><th class="text-right">Costo</th></tr></thead>
            <tbody>${Object.keys(monthly).sort().map(m => {
                const md = monthly[m];
                const mCred = proj.interactions > 0 ? (md.interactions / proj.interactions) * projCredits : 0;
                return `<tr>
                    <td>${new Date(m+'-01').toLocaleDateString('es-MX',{month:'long',year:'numeric'})}</td>
                    <td class="mono text-right">${fmtNum(md.interactions)}</td>
                    <td class="mono text-right">${fmtNum(md.users)}</td>
                    <td class="mono text-right" style="color:var(--accent-indigo)">${fmtNum(mCred,0)}</td>
                    <td class="mono text-right" style="color:var(--accent-emerald)">$${fmtNum(mCred*creditToUSD,2)}</td>
                </tr>`;
            }).join('')}</tbody>
        </table></div>
    </div>

    <div class="insight-card" style="margin-bottom:1.25rem">
        <div class="insight-card-header"><div class="insight-icon" style="background:rgba(245,158,11,.15)">ğŸ‘¤</div><div class="insight-card-title">Costo por Usuario â€” ${grade}Â°</div></div>
        <div class="insight-card-body">
            <strong>Semanal:</strong> ${fmtNum(credPerConv*MAX_CONVS_PER_WEEK,1)} crÃ©d ($${fmtNum(credPerConv*MAX_CONVS_PER_WEEK*creditToUSD,3)}) â€”
            <strong>Mensual:</strong> ${fmtNum(credPerConv*MAX_CONVS_PER_WEEK*4.33,0)} crÃ©d ($${fmtNum(credPerConv*MAX_CONVS_PER_WEEK*4.33*creditToUSD,2)}) â€”
            <strong>Anual:</strong> ${fmtNum(yearlyPerUser,0)} crÃ©d ($${fmtNum(yearlyPerUser*creditToUSD,2)})
            <br><em style="font-size:.75rem;color:var(--text-muted)">MÃ¡x ${MAX_CONVS_PER_WEEK} conv/sem, ${WEEKS_PER_YEAR} semanas</em>
        </div>
    </div>`;

    // Render grade charts
    if (typeof Chart === 'undefined') return;
    setTimeout(() => {
        try {
        destroyChart(`g${grade}Daily`);
        destroyChart(`g${grade}Monthly`);

        const dailyValues = days.map(d => daily[d].interactions * credPerInt);
        const ctxD = document.getElementById(`${cId}Daily`);
        if (ctxD) {
            STATE.charts[`g${grade}Daily`] = new Chart(ctxD.getContext('2d'), {
                type: 'line',
                data: { labels: days.map(d => new Date(d).toLocaleDateString('es-MX',{day:'2-digit',month:'short'})), datasets: [{ label: 'CrÃ©ditos/dÃ­a', data: dailyValues, borderColor: '#6366f1', backgroundColor: '#6366f120', fill: true, tension: 0.3, pointRadius: 2, borderWidth: 2 }] },
                options: CHART_DEFAULTS
            });
        }

        const mKeys = Object.keys(monthly).sort();
        const ctxM = document.getElementById(`${cId}Monthly`);
        if (ctxM) {
            STATE.charts[`g${grade}Monthly`] = new Chart(ctxM.getContext('2d'), {
                type: 'bar',
                data: { labels: mKeys.map(m => new Date(m+'-01').toLocaleDateString('es-MX',{month:'short',year:'2-digit'})), datasets: [{ label: 'CrÃ©ditos', data: mKeys.map(m => proj.interactions > 0 ? (monthly[m].interactions / proj.interactions) * projCredits : 0), backgroundColor: '#6366f1cc', borderColor: '#6366f1', borderWidth: 1 }] },
                options: { ...CHART_DEFAULTS, plugins: { ...CHART_DEFAULTS.plugins, legend: { display: false } } }
            });
        }
        } catch(e) { console.error(`Chart error grade ${grade}:`, e); }
    }, 50);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROJECTIONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderProjectionsCurrent() {
    const vfCredits = getVFCredits();
    const totals = getTotals();
    const credPerConv = totals.users > 0 ? vfCredits / totals.users : 0;
    const credPerInt = getCredPerInteraction();
    const creditToUSD = getCreditToUSD();

    document.getElementById('projCurrentMetrics').innerHTML = `
        <div class="metric-card mc-indigo">
            <div class="metric-label">CrÃ©ditos / InteracciÃ³n (real)</div>
            <div class="metric-value">${credPerInt.toFixed(2)}</div>
            <div class="metric-sub">promedio calibrado</div>
        </div>
        <div class="metric-card mc-amber">
            <div class="metric-label">Precio / CrÃ©dito</div>
            <div class="metric-value">$${creditToUSD.toFixed(4)}</div>
            <div class="metric-sub">${fmtNum(getPlanCost())} / ${fmtNum(getPlanTotal())} crÃ©d</div>
        </div>
        <div class="metric-card mc-emerald">
            <div class="metric-label">CrÃ©d. / ConversaciÃ³n (global)</div>
            <div class="metric-value">${fmtNum(credPerConv, 1)}</div>
        </div>`;

    const tbody = document.getElementById('projCurrentTableBody');
    tbody.innerHTML = PROJECTS.map(p => {
        const proj = STATE.rawData.find(r => r.grade === p.grade);
        if (!proj || proj.users === 0) return null;
        const pc = getProjectCredits(proj);
        const cpc = pc / proj.users;
        const yearly = cpc * MAX_CONVS_PER_YEAR;
        return `<tr><td><strong>${p.grade}Â°</strong></td><td class="mono text-right">${fmtNum(cpc,1)}</td><td class="mono text-right">${fmtNum(yearly,0)}</td><td class="mono text-right" style="color:var(--accent-emerald)">$${fmtNum(yearly*creditToUSD,2)}</td></tr>`;
    }).filter(Boolean).join('') || '<tr><td colspan="4" style="text-align:center;color:var(--text-muted)">Sin datos</td></tr>';
}

function runSimulation() {
    if (!STATE.loaded) { alert('Carga datos primero'); return; }
    const simModel = document.getElementById('simModelSelect').value;
    const baseModel = document.getElementById('simBaseModelSelect').value;
    const simRate = MODEL_CRED_PER_MSG[simModel] || 0;
    const baseRate = MODEL_CRED_PER_MSG[baseModel] || 1;
    const ratio = baseRate > 0 ? simRate / baseRate : 1;
    const creditToUSD = getCreditToUSD();

    const tbody = document.getElementById('simCompTableBody');
    let totActual = 0, totSim = 0;
    const rows = PROJECTS.map(p => {
        const proj = STATE.rawData.find(r => r.grade === p.grade);
        if (!proj || proj.users === 0) return null;
        const pc = getProjectCredits(proj);
        const cpcActual = pc / proj.users;
        const cpcSim = cpcActual * ratio;
        const yActual = cpcActual * MAX_CONVS_PER_YEAR * creditToUSD;
        const ySim = cpcSim * MAX_CONVS_PER_YEAR * creditToUSD;
        totActual += yActual;
        totSim += ySim;
        const savings = yActual - ySim;
        return `<tr>
            <td><strong>${p.grade}Â°</strong></td>
            <td class="mono">$${fmtNum(yActual,2)}</td>
            <td class="mono">$${fmtNum(ySim,2)}</td>
            <td class="mono" style="color:${savings>0?'var(--accent-emerald)':'var(--accent-rose)'}">${savings>0?'+':''}$${fmtNum(savings,2)}</td>
        </tr>`;
    }).filter(Boolean);

    const totalSavings = totActual - totSim;
    rows.push(`<tr style="border-top:2px solid var(--border);font-weight:700">
        <td>TOTAL (por usuario)</td>
        <td class="mono">$${fmtNum(totActual / PROJECTS.length,2)}</td>
        <td class="mono">$${fmtNum(totSim / PROJECTS.length,2)}</td>
        <td class="mono" style="color:${totalSavings>0?'var(--accent-emerald)':'var(--accent-rose)'}">${totalSavings>0?'+':''}$${fmtNum(totalSavings / PROJECTS.length,2)}</td>
    </tr>`);

    tbody.innerHTML = rows.join('');
    document.getElementById('simResults').style.display = '';
}

function runCapacity() {
    if (!STATE.loaded) { alert('Carga datos primero'); return; }
    const totalUsers = parseInt(document.getElementById('capGlobalUsers').value) || 100;
    const convsYear = parseInt(document.getElementById('capConvsYear').value) || MAX_CONVS_PER_YEAR;
    const creditToUSD = getCreditToUSD();
    const perGrade = Math.ceil(totalUsers / PROJECTS.length);

    let totalCredits = 0;
    const tbody = document.getElementById('capTableBody');
    const rows = PROJECTS.map(p => {
        const proj = STATE.rawData.find(r => r.grade === p.grade);
        const credPerConv = proj && proj.users > 0 ? getProjectCredits(proj) / proj.users : (getVFCredits() / (getTotals().users || 1));
        const credits = perGrade * convsYear * credPerConv;
        totalCredits += credits;
        return `<tr><td><strong>${p.grade}Â°</strong></td><td class="mono text-right">${perGrade}</td><td class="mono text-right">${fmtNum(credits,0)}</td><td class="mono text-right" style="color:var(--accent-amber)">$${fmtNum(credits*creditToUSD,2)}</td></tr>`;
    });

    rows.push(`<tr style="border-top:2px solid var(--border);font-weight:700"><td>TOTAL</td><td class="mono text-right">${totalUsers}</td><td class="mono text-right">${fmtNum(totalCredits,0)}</td><td class="mono text-right" style="color:var(--accent-amber)">$${fmtNum(totalCredits*creditToUSD,2)}</td></tr>`);
    tbody.innerHTML = rows.join('');

    document.getElementById('capMetrics').innerHTML = `
        <div class="metric-card mc-indigo"><div class="metric-label">CrÃ©ditos Totales/AÃ±o</div><div class="metric-value">${fmtNum(totalCredits,0)}</div><div class="metric-sub">$${fmtNum(totalCredits*creditToUSD,2)} USD</div></div>
        <div class="metric-card mc-amber"><div class="metric-label">$/Usuario/AÃ±o</div><div class="metric-value">$${fmtNum(totalUsers>0?totalCredits*creditToUSD/totalUsers:0,2)}</div></div>
        <div class="metric-card ${totalCredits <= getPlanTotal() ? 'mc-emerald' : 'mc-rose'}"><div class="metric-label">${totalCredits <= getPlanTotal() ? 'Dentro del Plan' : 'Excede el Plan'}</div><div class="metric-value">${(totalCredits/getPlanTotal()*100).toFixed(1)}%</div><div class="metric-sub">${fmtNum(totalCredits,0)} / ${fmtNum(getPlanTotal(),0)} crÃ©ditos</div></div>`;

    document.getElementById('capResults').style.display = '';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILITIES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmtNum(n, decimals = null) {
    if (n === null || n === undefined || isNaN(n)) return 'â€”';
    if (decimals !== null) return n.toLocaleString('en-US', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    if (Math.abs(n) >= 1_000_000) return (n / 1_000_000).toFixed(2) + 'M';
    if (Math.abs(n) >= 10_000) return (n / 1_000).toFixed(1) + 'K';
    return n.toLocaleString('en-US', { maximumFractionDigits: 2 });
}

function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
function updateLoadingProgress(t) { document.getElementById('loadingProgress').textContent = t; }
function setStatus(type, text) { document.getElementById('statusDot').className = 'status-dot ' + type; document.getElementById('statusText').textContent = text; }

function exportCSV() {
    if (!STATE.loaded) { alert('Carga datos primero'); return; }
    const creditToUSD = getCreditToUSD();
    let csv = 'Grado,Interacciones,Conversaciones,Promedio Msgs/Conv,CrÃ©ditos (Proporc.),Costo USD\n';
    STATE.rawData.forEach(p => {
        const c = getProjectCredits(p);
        csv += `"${p.project}",${p.interactions},${p.users},${p.average.toFixed(2)},${c.toFixed(0)},${(c*creditToUSD).toFixed(2)}\n`;
    });
    csv += `\n\nDetalle Mensual\nMes,Interacciones,Conversaciones,CrÃ©ditos,Costo USD\n`;
    const monthly = aggregateMonthly();
    const totalInt = getTotalInteractions();
    Object.entries(monthly).sort().forEach(([m, d]) => {
        const c = totalInt > 0 ? (d.interactions / totalInt) * getVFCredits() : 0;
        csv += `"${m}",${d.interactions},${d.users},${c.toFixed(0)},${(c*getCreditToUSD()).toFixed(2)}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `xolo-credits-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}
</script>
</body>
</html>
