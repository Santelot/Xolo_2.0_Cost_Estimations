<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xolo AI â€” Credit Analytics Dashboard v2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.7/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300..800;1,9..40,300..800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
:root {
    --bg-base: #0a0e1a;
    --bg-surface: #111827;
    --bg-card: #1a2236;
    --bg-card-hover: #1f2b42;
    --bg-input: #0d1220;
    --border: #2a3550;
    --border-active: #6366f1;
    --text-primary: #e8ecf4;
    --text-secondary: #8892a8;
    --text-muted: #5a6478;
    --accent-indigo: #6366f1;
    --accent-violet: #8b5cf6;
    --accent-emerald: #10b981;
    --accent-amber: #f59e0b;
    --accent-rose: #f43f5e;
    --accent-cyan: #06b6d4;
    --accent-blue: #3b82f6;
    --accent-lime: #84cc16;
    --accent-orange: #f97316;
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 14px;
    --radius-xl: 18px;
    --shadow-card: 0 2px 12px rgba(0,0,0,.35);
    --shadow-elevated: 0 8px 30px rgba(0,0,0,.5);
    --font-sans: 'DM Sans', system-ui, -apple-system, sans-serif;
    --font-mono: 'JetBrains Mono', 'SF Mono', monospace;
    --transition: .2s cubic-bezier(.4,0,.2,1);
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
body { font-family: var(--font-sans); background: var(--bg-base); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; }

.app-shell { max-width: 1440px; margin: 0 auto; padding: 1.5rem; }

.header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 1.25rem 1.75rem; background: var(--bg-surface);
    border: 1px solid var(--border); border-radius: var(--radius-xl); margin-bottom: 1.25rem;
}
.header-left { display: flex; align-items: center; gap: 1rem; }
.logo-mark {
    width: 42px; height: 42px;
    background: linear-gradient(135deg, var(--accent-indigo), var(--accent-violet));
    border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;
    font-size: 1.4rem; font-weight: 800; color: #fff;
}
.header h1 { font-size: 1.35rem; font-weight: 700; letter-spacing: -.02em; }
.header h1 span { color: var(--accent-indigo); }
.header-subtitle { font-size: .8rem; color: var(--text-muted); font-weight: 500; }
.header-right { display: flex; align-items: center; gap: .75rem; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-emerald); box-shadow: 0 0 8px rgba(16,185,129,.5); }
.status-dot.loading { background: var(--accent-amber); animation: pulse-dot 1.2s infinite; }
.status-dot.error { background: var(--accent-rose); }
.status-dot.warning { background: var(--accent-amber); }
@keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:.4} }

/* TABS */
.tab-bar { display: flex; gap: .35rem; padding: .35rem; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-lg); margin-bottom: 1.25rem; overflow-x: auto; scrollbar-width: none; }
.tab-bar::-webkit-scrollbar { display: none; }
.tab-btn { padding: .6rem 1.1rem; background: transparent; border: none; color: var(--text-secondary); font-family: var(--font-sans); font-size: .82rem; font-weight: 600; border-radius: var(--radius-md); cursor: pointer; white-space: nowrap; transition: var(--transition); }
.tab-btn:hover { color: var(--text-primary); background: var(--bg-card); }
.tab-btn.active { background: var(--accent-indigo); color: #fff; box-shadow: 0 2px 10px rgba(99,102,241,.35); }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* CONTROLS */
.controls-bar { display: flex; flex-wrap: wrap; gap: .75rem; align-items: flex-end; padding: 1.25rem; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-lg); margin-bottom: 1.25rem; }
.ctrl-group { display: flex; flex-direction: column; gap: .35rem; }
.ctrl-group label { font-size: .72rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .06em; }
.ctrl-input, .ctrl-select { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary); padding: .55rem .85rem; border-radius: var(--radius-sm); font-family: var(--font-sans); font-size: .85rem; min-width: 150px; transition: var(--transition); }
.ctrl-input:focus, .ctrl-select:focus { outline: none; border-color: var(--accent-indigo); box-shadow: 0 0 0 3px rgba(99,102,241,.15); }
.btn { display: inline-flex; align-items: center; gap: .45rem; padding: .55rem 1.25rem; border: none; border-radius: var(--radius-sm); font-family: var(--font-sans); font-size: .85rem; font-weight: 600; cursor: pointer; transition: var(--transition); white-space: nowrap; }
.btn-primary { background: var(--accent-indigo); color: #fff; }
.btn-primary:hover { background: #5558e6; transform: translateY(-1px); box-shadow: 0 4px 14px rgba(99,102,241,.3); }
.btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
.btn-secondary:hover { border-color: var(--accent-indigo); }
.btn-success { background: var(--accent-emerald); color: #fff; }
.btn-success:hover { background: #059669; }
.btn-warning { background: var(--accent-amber); color: #000; }
.btn-warning:hover { background: #d97706; }
.btn:disabled { opacity: .5; cursor: not-allowed; transform: none !important; }
.ctrl-spacer { flex: 1; min-width: 1rem; }

/* TOGGLE */
.toggle-group { display: inline-flex; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-sm); overflow: hidden; }
.toggle-btn { padding: .5rem .9rem; background: transparent; border: none; color: var(--text-secondary); font-family: var(--font-sans); font-size: .78rem; font-weight: 600; cursor: pointer; transition: var(--transition); }
.toggle-btn.active { background: var(--accent-indigo); color: #fff; }
.toggle-btn:hover:not(.active) { color: var(--text-primary); }

/* CHIPS / FILTERS */
.filter-section { padding: 1rem 1.25rem; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-lg); margin-bottom: 1.25rem; }
.filter-section-title { font-size: .75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: .06em; margin-bottom: .6rem; display: flex; align-items: center; gap: .5rem; }
.filter-row { display: flex; flex-wrap: wrap; gap: .4rem; align-items: center; }
.chip { padding: .3rem .7rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 100px; font-family: var(--font-sans); font-size: .75rem; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: var(--transition); user-select: none; }
.chip:hover { border-color: var(--accent-indigo); color: var(--text-primary); }
.chip.active { background: rgba(99,102,241,.15); border-color: var(--accent-indigo); color: var(--accent-indigo); }
.chip.excluded { background: rgba(244,63,94,.1); border-color: var(--accent-rose); color: var(--accent-rose); text-decoration: line-through; opacity: .7; }
.filter-info { font-size: .72rem; color: var(--text-muted); margin-top: .5rem; font-style: italic; }

/* METRICS */
.metrics-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.25rem; }
.metric-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.15rem; position: relative; transition: var(--transition); }
.metric-card:hover { border-color: var(--border-active); transform: translateY(-2px); box-shadow: var(--shadow-card); }
.metric-label { font-size: .7rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .06em; display: flex; align-items: center; gap: .4rem; margin-bottom: .5rem; }
.metric-value { font-size: 1.7rem; font-weight: 800; letter-spacing: -.03em; font-family: var(--font-mono); }
.metric-sub { font-size: .75rem; color: var(--text-secondary); margin-top: .25rem; }
.mc-indigo .metric-value { color: var(--accent-indigo); }
.mc-emerald .metric-value { color: var(--accent-emerald); }
.mc-amber .metric-value { color: var(--accent-amber); }
.mc-rose .metric-value { color: var(--accent-rose); }
.mc-cyan .metric-value { color: var(--accent-cyan); }
.mc-violet .metric-value { color: var(--accent-violet); }
.mc-blue .metric-value { color: var(--accent-blue); }
.mc-orange .metric-value { color: var(--accent-orange); }

/* INFO TOOLTIP */
.info-icon { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; background: var(--bg-input); border: 1px solid var(--border); font-size: .6rem; font-weight: 700; color: var(--text-muted); cursor: help; position: relative; flex-shrink: 0; }
.info-icon::after { content: attr(data-tooltip); position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: var(--bg-base); border: 1px solid var(--border); color: var(--text-secondary); padding: .6rem .85rem; border-radius: var(--radius-sm); font-size: .72rem; font-weight: 400; line-height: 1.45; white-space: normal; width: max-content; max-width: 360px; opacity: 0; pointer-events: none; transition: opacity .2s; z-index: 999; box-shadow: var(--shadow-elevated); text-transform: none; letter-spacing: 0; font-family: var(--font-sans); }
.info-icon:hover::after { opacity: 1; }

/* CHARTS */
.chart-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1.25rem; }
.chart-panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; }
.chart-panel-title { font-size: .95rem; font-weight: 700; display: flex; align-items: center; gap: .5rem; }
.chart-wrap { position: relative; height: 300px; }

/* TABLES */
.data-table-wrap { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; margin-bottom: 1.25rem; }
.data-table-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); }
.data-table-title { font-size: .95rem; font-weight: 700; display: flex; align-items: center; gap: .5rem; }
.data-table { width: 100%; border-collapse: collapse; }
.data-table th, .data-table td { padding: .7rem 1rem; text-align: left; border-bottom: 1px solid rgba(42,53,80,.5); font-size: .82rem; }
.data-table th { background: var(--bg-surface); font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .05em; font-size: .7rem; position: sticky; top: 0; }
.data-table tbody tr:hover td { background: var(--bg-card-hover); }
.data-table .mono { font-family: var(--font-mono); font-weight: 600; }
.data-table .text-right { text-align: right; }

/* INSIGHTS */
.insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 1rem; margin-bottom: 1.25rem; }
.insight-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.25rem; }
.insight-card-header { display: flex; align-items: center; gap: .5rem; margin-bottom: .75rem; }
.insight-icon { width: 32px; height: 32px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 1rem; }
.insight-card-title { font-size: .85rem; font-weight: 700; }
.insight-card-body { font-size: .82rem; color: var(--text-secondary); line-height: 1.55; }
.insight-card-body strong { color: var(--text-primary); }

/* PROJECTIONS */
.projection-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1.25rem; }
.projection-title { font-size: 1.05rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: .5rem; }
.sim-input-row { display: flex; flex-wrap: wrap; gap: .75rem; align-items: flex-end; margin-bottom: 1rem; }
.comparison-table { width: 100%; border-collapse: collapse; }
.comparison-table th, .comparison-table td { padding: .65rem .85rem; text-align: center; border-bottom: 1px solid rgba(42,53,80,.5); font-size: .8rem; }
.comparison-table th { background: var(--bg-surface); font-weight: 600; color: var(--text-muted); font-size: .7rem; text-transform: uppercase; letter-spacing: .05em; }

.badge { display: inline-block; padding: .15rem .5rem; border-radius: 100px; font-size: .7rem; font-weight: 600; }
.badge-danger { background: rgba(244,63,94,.15); color: var(--accent-rose); }
.badge-warning { background: rgba(245,158,11,.15); color: var(--accent-amber); }
.badge-success { background: rgba(16,185,129,.15); color: var(--accent-emerald); }

/* LOADING */
.loading-overlay { position: fixed; inset: 0; background: rgba(10,14,26,.92); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(4px); }
.loading-overlay.hidden { display: none; }
.loading-spinner { width: 48px; height: 48px; border: 3px solid var(--border); border-top-color: var(--accent-indigo); border-radius: 50%; animation: spin .8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-label { margin-top: 1rem; color: var(--text-secondary); font-size: .9rem; }
.loading-progress { margin-top: .5rem; color: var(--text-muted); font-size: .78rem; font-family: var(--font-mono); }

.empty-state { text-align: center; padding: 3rem 2rem; color: var(--text-muted); }
.empty-state-icon { font-size: 2.5rem; margin-bottom: .75rem; }

.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
@media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }
@media (max-width: 768px) {
    .app-shell { padding: .75rem; }
    .header { flex-direction: column; gap: .75rem; text-align: center; }
    .metrics-row { grid-template-columns: repeat(2, 1fr); }
    .insights-grid { grid-template-columns: 1fr; }
    .controls-bar { flex-direction: column; align-items: stretch; }
    .ctrl-spacer { display: none; }
}
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>

<div class="loading-overlay hidden" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-label">Cargando datos de analÃ­tica...</div>
    <div class="loading-progress" id="loadingProgress"></div>
</div>

<div class="app-shell">

    <header class="header">
        <div class="header-left">
            <div class="logo-mark">X</div>
            <div>
                <h1>Xolo <span>Credit Analytics</span></h1>
                <div class="header-subtitle">Dashboard v2 â€” Datos reales de credit_usage API</div>
            </div>
        </div>
        <div class="header-right">
            <div class="status-dot" id="statusDot"></div>
            <span style="font-size:.78rem;color:var(--text-muted)" id="statusText">Listo</span>
        </div>
    </header>

    <nav class="tab-bar" id="tabBar">
        <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
        <button class="tab-btn" data-tab="models">Modelos LLM</button>
        <button class="tab-btn" data-tab="grade-3">3Â°</button>
        <button class="tab-btn" data-tab="grade-4">4Â°</button>
        <button class="tab-btn" data-tab="grade-5">5Â°</button>
        <button class="tab-btn" data-tab="grade-6">6Â°</button>
        <button class="tab-btn" data-tab="grade-7">7Â°</button>
        <button class="tab-btn" data-tab="grade-8">8Â°</button>
        <button class="tab-btn" data-tab="grade-9">9Â°</button>
        <button class="tab-btn" data-tab="grade-10">10Â°</button>
        <button class="tab-btn" data-tab="grade-11">11Â°</button>
        <button class="tab-btn" data-tab="grade-12">12Â°</button>
        <button class="tab-btn" data-tab="projections">âš¡ Proyecciones</button>
    </nav>

    <!-- CONTROLS -->
    <div class="controls-bar">
        <div class="ctrl-group">
            <label>PerÃ­odo</label>
            <select class="ctrl-select" id="periodPreset">
                <option value="this_month">Este mes</option>
                <option value="last_month">Mes pasado</option>
                <option value="last_3">Ãšltimos 3 meses</option>
                <option value="last_6">Ãšltimos 6 meses</option>
                <option value="all" selected>Todo el historial</option>
                <option value="custom">Personalizado</option>
            </select>
        </div>
        <div class="ctrl-group" id="customDateStart" style="display:none">
            <label>Desde</label>
            <input type="date" class="ctrl-input" id="startDate" value="2025-01-05">
        </div>
        <div class="ctrl-group" id="customDateEnd" style="display:none">
            <label>Hasta</label>
            <input type="date" class="ctrl-input" id="endDate">
        </div>
        <div class="ctrl-group">
            <label>Plan Total CrÃ©ditos</label>
            <input type="number" class="ctrl-input" id="planTotalCredits" value="2400000" min="0" style="width:150px">
        </div>
        <div class="ctrl-group">
            <label>Costo Plan (USD)</label>
            <input type="number" class="ctrl-input" id="planCostUSD" value="10800" min="0" step="0.01" style="width:120px">
        </div>
        <div class="ctrl-group">
            <label>Unidad</label>
            <div class="toggle-group" id="unitToggle">
                <button class="toggle-btn active" data-unit="credits">CrÃ©ditos</button>
                <button class="toggle-btn" data-unit="cost">USD $</button>
            </div>
        </div>
        <div class="ctrl-spacer"></div>
        <button class="btn btn-primary" id="btnFetch" onclick="fetchAllData()">â–¶ Cargar Datos</button>
        <button class="btn btn-secondary" onclick="exportCSV()">â†“ CSV</button>
    </div>

    <!-- MODEL FILTERS -->
    <div class="filter-section" id="modelFilterSection" style="display:none">
        <div class="filter-section-title">
            ğŸ”¬ Filtros de Modelo LLM
            <span class="info-icon" data-tooltip="Click en un modelo para excluirlo del cÃ¡lculo de crÃ©ditos. Los mensajes y usuarios NO se afectan. Ãštil para simular costos sin modelos experimentales.">i</span>
        </div>
        <div class="filter-row" id="modelChips"></div>
        <div class="filter-info" id="filterInfo">Todos los modelos activos â€” mostrando datos completos</div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD TAB â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="tab-content active" id="tab-dashboard">
        <!-- DOMAIN A: Credits -->
        <div style="font-size:.7rem;font-weight:700;color:var(--accent-indigo);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.5rem">Dominio A â€” CrÃ©ditos LLM (credit_usage API)</div>
        <div class="metrics-row" id="creditMetrics">
            <div class="metric-card mc-indigo">
                <div class="metric-label">CrÃ©ditos LLM Total <span class="info-icon" data-tooltip="Suma directa de credit_usage API. Datos reales, no estimados.">i</span></div>
                <div class="metric-value" id="kpiCreditsLLM">â€”</div>
                <div class="metric-sub" id="kpiCreditsLLMSub"></div>
            </div>
            <div class="metric-card mc-emerald">
                <div class="metric-label">Costo LLM (USD)</div>
                <div class="metric-value" id="kpiCostUSD">â€”</div>
                <div class="metric-sub" id="kpiCostUSDSub"></div>
            </div>
            <div class="metric-card mc-amber">
                <div class="metric-label">% Plan Usado <span class="info-icon" data-tooltip="CrÃ©ditos LLM / Plan total. No incluye hosting.">i</span></div>
                <div class="metric-value" id="kpiPlanPct">â€”</div>
                <div class="metric-sub" id="kpiPlanPctSub"></div>
            </div>
            <div class="metric-card mc-rose">
                <div class="metric-label">Burn Rate Mensual</div>
                <div class="metric-value" id="kpiBurnRate">â€”</div>
                <div class="metric-sub" id="kpiBurnRateSub"></div>
            </div>
        </div>

        <!-- DOMAIN B: Messaging -->
        <div style="font-size:.7rem;font-weight:700;color:var(--accent-cyan);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.5rem">Dominio B â€” MensajerÃ­a (interactions + unique_users API)</div>
        <div class="metrics-row" id="messagingMetrics">
            <div class="metric-card mc-cyan">
                <div class="metric-label">Total Mensajes</div>
                <div class="metric-value" id="kpiMessages">â€”</div>
                <div class="metric-sub" id="kpiMessagesSub"></div>
            </div>
            <div class="metric-card mc-violet">
                <div class="metric-label">Usuarios Ãšnicos</div>
                <div class="metric-value" id="kpiUsers">â€”</div>
                <div class="metric-sub" id="kpiUsersSub"></div>
            </div>
            <div class="metric-card mc-blue">
                <div class="metric-label">Msgs / Usuario <span class="info-icon" data-tooltip="Mensajes Ã· Usuarios. MÃ©trica pura de engagement, no toca crÃ©ditos.">i</span></div>
                <div class="metric-value" id="kpiMsgsPerUser">â€”</div>
                <div class="metric-sub" id="kpiMsgsPerUserSub"></div>
            </div>
        </div>

        <!-- COMBINED METRICS -->
        <div style="font-size:.7rem;font-weight:700;color:var(--accent-amber);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.5rem">MÃ©tricas Conjuntas (A Ã— B)</div>
        <div class="metrics-row" id="combinedMetrics">
            <div class="metric-card mc-orange">
                <div class="metric-label">CrÃ©d. LLM / Mensaje <span class="info-icon" data-tooltip="CrÃ©ditos LLM Ã· Mensajes. Variable segÃºn modelo. Afectado por filtros de modelo.">i</span></div>
                <div class="metric-value" id="kpiCredPerMsg">â€”</div>
                <div class="metric-sub" id="kpiCredPerMsgSub"></div>
            </div>
            <div class="metric-card mc-violet">
                <div class="metric-label">CrÃ©d. LLM / Usuario</div>
                <div class="metric-value" id="kpiCredPerUser">â€”</div>
                <div class="metric-sub" id="kpiCredPerUserSub"></div>
            </div>
            <div class="metric-card mc-emerald">
                <div class="metric-label">Gran Total (LLM+Hosting) <span class="info-icon" data-tooltip="CrÃ©ditos LLM + (Mensajes Ã— 1 crÃ©dito hosting). El hosting viene del dominio de mensajerÃ­a.">i</span></div>
                <div class="metric-value" id="kpiGrandTotal">â€”</div>
                <div class="metric-sub" id="kpiGrandTotalSub"></div>
            </div>
            <div class="metric-card mc-rose">
                <div class="metric-label">ProyecciÃ³n Fin PerÃ­odo</div>
                <div class="metric-value" id="kpiProjection">â€”</div>
                <div class="metric-sub" id="kpiProjectionSub"></div>
            </div>
        </div>

        <div class="two-col">
            <div class="chart-panel">
                <div class="chart-panel-header">
                    <div class="chart-panel-title">ğŸ“Š CrÃ©ditos LLM Mensuales</div>
                </div>
                <div class="chart-wrap"><canvas id="chartMonthlyCredits"></canvas></div>
            </div>
            <div class="chart-panel">
                <div class="chart-panel-header">
                    <div class="chart-panel-title">ğŸ“ˆ Tendencia Diaria</div>
                </div>
                <div class="chart-wrap"><canvas id="chartDailyTrend"></canvas></div>
            </div>
        </div>

        <div class="two-col">
            <div class="chart-panel">
                <div class="chart-panel-header">
                    <div class="chart-panel-title">ğŸ« CrÃ©ditos LLM por Grado</div>
                </div>
                <div class="chart-wrap"><canvas id="chartByGrade"></canvas></div>
            </div>
            <div class="chart-panel">
                <div class="chart-panel-header">
                    <div class="chart-panel-title">ğŸ¤– CrÃ©ditos por Modelo LLM</div>
                </div>
                <div class="chart-wrap"><canvas id="chartByModel"></canvas></div>
            </div>
        </div>

        <div class="data-table-wrap">
            <div class="data-table-header">
                <div class="data-table-title">ğŸ“… Detalle Mensual</div>
            </div>
            <div style="overflow-x:auto">
                <table class="data-table" id="monthlyTable">
                    <thead><tr>
                        <th>Mes</th>
                        <th class="text-right">CrÃ©ditos LLM</th>
                        <th class="text-right">Mensajes</th>
                        <th class="text-right">Usuarios</th>
                        <th class="text-right">CrÃ©d/Msg</th>
                        <th class="text-right">Costo USD</th>
                        <th>Tendencia</th>
                    </tr></thead>
                    <tbody id="monthlyTableBody">
                        <tr><td colspan="7" class="empty-state"><div class="empty-state-icon">ğŸ“Š</div>Haz clic en "Cargar Datos"</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="insights-grid" id="insightsGrid"></div>
    </div>

    <!-- MODELS TAB -->
    <div class="tab-content" id="tab-models"></div>

    <!-- GRADE TABS -->
    <div class="tab-content" id="tab-grade-3"></div>
    <div class="tab-content" id="tab-grade-4"></div>
    <div class="tab-content" id="tab-grade-5"></div>
    <div class="tab-content" id="tab-grade-6"></div>
    <div class="tab-content" id="tab-grade-7"></div>
    <div class="tab-content" id="tab-grade-8"></div>
    <div class="tab-content" id="tab-grade-9"></div>
    <div class="tab-content" id="tab-grade-10"></div>
    <div class="tab-content" id="tab-grade-11"></div>
    <div class="tab-content" id="tab-grade-12"></div>

    <!-- PROJECTIONS TAB -->
    <div class="tab-content" id="tab-projections">
        <div class="projection-section">
            <div class="projection-title">ğŸ“ ProyecciÃ³n con Filtros de Modelo</div>
            <p style="color:var(--text-secondary);font-size:.82rem;margin-bottom:1rem;">
                Usa los filtros de modelo (arriba) para excluir modelos experimentales. La proyecciÃ³n se recalcula automÃ¡ticamente mostrando el costo estimado si solo se usara(n) los modelos no excluidos.
            </p>
            <div class="metrics-row" id="projFilteredMetrics"></div>
            <div style="overflow-x:auto;margin-top:1rem">
                <table class="data-table" id="projFilteredTable">
                    <thead><tr>
                        <th>Grado</th>
                        <th class="text-right">CrÃ©d. LLM (filtrados)</th>
                        <th class="text-right">Mensajes</th>
                        <th class="text-right">CrÃ©d/Msg (filtrado)</th>
                        <th class="text-right">Costo USD</th>
                    </tr></thead>
                    <tbody id="projFilteredTableBody"><tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:2rem">Carga datos primero</td></tr></tbody>
                </table>
            </div>
        </div>

        <div class="projection-section">
            <div class="projection-title">ğŸ“‹ Planificador de Capacidad</div>
            <p style="color:var(--text-secondary);font-size:.82rem;margin-bottom:1rem;">
                Estima el costo anual basado en el promedio real de crÃ©ditos LLM por mensaje (respeta filtros de modelo activos).
            </p>
            <div class="sim-input-row">
                <div class="ctrl-group">
                    <label>Usuarios Totales</label>
                    <input type="number" class="ctrl-input" id="capUsers" value="100" min="1" style="width:100px">
                </div>
                <div class="ctrl-group">
                    <label>Msgs / Usuario / AÃ±o</label>
                    <input type="number" class="ctrl-input" id="capMsgsYear" value="1000" min="1" style="width:120px">
                </div>
                <button class="btn btn-success" onclick="runCapacity()">ğŸ“Š Calcular</button>
            </div>
            <div id="capResults" style="display:none">
                <div class="metrics-row" id="capMetrics"></div>
            </div>
        </div>
    </div>

</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIGURATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PROXY_URL = "https://voiceflow-analytics.chat-gpt-bc7.workers.dev";
const COSTO_POR_CREDITO = 0.005;
const CREDITO_HOSTING = 1; // 1 credit per message (fixed by VoiceFlow)

const PROJECTS = [
    { name:"Xolo 2.0 - 3", grade:3, id:"69648a3142fb1cac823bd719", key:"VF.DM.69648b19774372ae83b64a6f.Gxyvv88zdFVvrfhL" },
    { name:"Xolo 2.0 - 4", grade:4, id:"696467d942fb1cac823bd1e3", key:"VF.DM.696485c0aeb01b0b69b6a670.GW6aEdVYlOCsmKgi" },
    { name:"Xolo 2.0 - 5", grade:5, id:"696467a542fb1cac823bd1d7", key:"VF.DM.6964854eb6139e75b888f46d.xdHG0G0Nuyvkinz5" },
    { name:"Xolo 2.0 - 6", grade:6, id:"696467c442fb1cac823bd1de", key:"VF.DM.6964842142cf44d88c7bc011.A7CKjUYFqJBBzz9I" },
    { name:"Xolo 2.0 - 7", grade:7, id:"69648b3442fb1cac823bd724", key:"VF.DM.69649147b6139e75b888f470.VxjRlJ1aUQQ0XSmW" },
    { name:"Xolo 2.0 - 8", grade:8, id:"6964915b42fb1cac823bd760", key:"VF.DM.696492ee3de508144d819027.li2BDyTMZLRxqJMf" },
    { name:"Xolo 2.0 - 9", grade:9, id:"69648b5842fb1cac823bd729", key:"VF.DM.69648e9ab6139e75b888f46e.NS8oW3YkgnPW7Fqm" },
    { name:"Xolo 2.0 - 10", grade:10, id:"6964931942fb1cac823bd788", key:"VF.DM.69649443b6139e75b888f471.OztVLPOnLPZbPdTz" },
    { name:"Xolo 2.0 - 11", grade:11, id:"6964947942fb1cac823bd7a6", key:"VF.DM.696494d7fbbabc183d666b77.bsj9cKB680jegVI2" },
    { name:"Xolo 2.0 - 12", grade:12, id:"6964948942fb1cac823bd7ab", key:"VF.DM.6964952daeb01b0b69b6a672.axrKSvL4BDs6LUgO" }
];

const GRADE_COLORS = ['#6366f1','#8b5cf6','#a855f7','#c084fc','#34d399','#10b981','#06b6d4','#3b82f6','#f59e0b','#f97316'];
const MODEL_COLORS = ['#6366f1','#f43f5e','#10b981','#f59e0b','#06b6d4','#8b5cf6','#f97316','#3b82f6','#84cc16','#a855f7','#ec4899','#14b8a6'];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE â€” SeparaciÃ³n estricta de dominios
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let STATE = {
    // Raw data â€” immutable after fetch
    raw: {
        creditUsage: new Map(),   // Map<projectID, CreditItem[]>
        interactions: new Map(),  // Map<projectID, InteractionItem[]>
        uniqueUsers: new Map(),   // Map<projectID, UserItem[]>
    },
    // Discovered models from credit_usage
    discoveredModels: [],
    // Excluded models (for filtering)
    excludedModels: new Set(),
    // Computed â€” recalculated when filters change
    computed: null,
    // UI
    activeTab: "dashboard",
    activeUnit: "credits",
    charts: {},
    loaded: false,
    dateRange: { start: null, end: null },
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getPlanTotal() { return parseFloat(document.getElementById('planTotalCredits').value) || 2400000; }
function getPlanCost()  { return parseFloat(document.getElementById('planCostUSD').value) || 10800; }
function getCreditToUSD() { return getPlanCost() / getPlanTotal(); }
function fmtNum(n, dec = null) {
    if (n === null || n === undefined || isNaN(n)) return 'â€”';
    if (dec !== null) return n.toLocaleString('en-US', { minimumFractionDigits: dec, maximumFractionDigits: dec });
    if (Math.abs(n) >= 1_000_000) return (n / 1_000_000).toFixed(2) + 'M';
    if (Math.abs(n) >= 10_000) return (n / 1_000).toFixed(1) + 'K';
    return n.toLocaleString('en-US', { maximumFractionDigits: 2 });
}
function formatVal(credits) {
    if (STATE.activeUnit === 'cost') return '$' + fmtNum(credits * getCreditToUSD(), 2);
    return fmtNum(credits);
}
function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
function updateLoadingProgress(t) { document.getElementById('loadingProgress').textContent = t; }
function setStatus(type, text) { document.getElementById('statusDot').className = 'status-dot ' + type; document.getElementById('statusText').textContent = text; }
function destroyChart(key) { if (STATE.charts[key]) { STATE.charts[key].destroy(); delete STATE.charts[key]; } }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('endDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = '2025-01-05';

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });
    document.querySelectorAll('#unitToggle .toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('#unitToggle .toggle-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            STATE.activeUnit = btn.dataset.unit;
            if (STATE.loaded) { recalculate(); renderAll(); }
        });
    });
    document.getElementById('periodPreset').addEventListener('change', handlePeriodChange);
    hideLoading();
});

function switchTab(tabId) {
    STATE.activeTab = tabId;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === `tab-${tabId}`));
    if (STATE.loaded) {
        if (tabId.startsWith('grade-')) renderGradeTab(parseInt(tabId.split('-')[1]));
        if (tabId === 'models') renderModelsTab();
        if (tabId === 'projections') renderProjectionsTab();
    }
}

function handlePeriodChange() {
    const val = document.getElementById('periodPreset').value;
    const today = new Date();
    document.getElementById('customDateStart').style.display = val === 'custom' ? '' : 'none';
    document.getElementById('customDateEnd').style.display = val === 'custom' ? '' : 'none';
    if (val === 'custom') return;
    let start;
    switch(val) {
        case 'this_month': start = new Date(today.getFullYear(), today.getMonth(), 1); break;
        case 'last_month':
            start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            document.getElementById('endDate').value = new Date(today.getFullYear(), today.getMonth(), 0).toISOString().split('T')[0];
            document.getElementById('startDate').value = start.toISOString().split('T')[0];
            return;
        case 'last_3': start = new Date(today.getFullYear(), today.getMonth() - 3, 1); break;
        case 'last_6': start = new Date(today.getFullYear(), today.getMonth() - 6, 1); break;
        case 'all': start = new Date('2025-01-05'); break;
    }
    document.getElementById('startDate').value = start.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API FETCHING â€” Phase 1 (immutable raw data)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchAllPages(project, queryName, startTime, endTime) {
    let allItems = [], cursor = null, hasMore = true, pages = 0;
    while (hasMore && pages < 50) {
        const body = { data: { name: queryName, filter: { projectID: project.id, startTime, endTime, limit: 500 } } };
        if (cursor) body.data.filter.cursor = cursor;
        try {
            const resp = await fetch(`${PROXY_URL}/v2/query/usage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': project.key },
                body: JSON.stringify(body)
            });
            if (!resp.ok) {
                const text = await resp.text().catch(() => '');
                throw new Error(`HTTP ${resp.status}: ${text.substring(0, 200)}`);
            }
            const data = await resp.json();
            if (data.result && data.result.items) {
                allItems = allItems.concat(data.result.items);
                cursor = data.result.cursor;
                hasMore = !!cursor && data.result.items.length > 0;
            } else { hasMore = false; }
        } catch (err) { throw new Error(`${queryName}@${project.name}: ${err.message}`); }
        pages++;
    }
    return allItems;
}

async function fetchProjectData(project, startTime, endTime) {
    const [creditData, interactionsData, usersData] = await Promise.all([
        fetchAllPages(project, 'credit_usage', startTime, endTime),
        fetchAllPages(project, 'interactions', startTime, endTime),
        fetchAllPages(project, 'unique_users', startTime, endTime),
    ]);
    return { projectId: project.id, grade: project.grade, name: project.name, creditData, interactionsData, usersData };
}

async function fetchAllData() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    if (!startDate || !endDate) { alert('Selecciona fechas'); return; }

    const startTime = new Date(startDate).toISOString();
    const endTime = new Date(endDate + 'T23:59:59').toISOString();
    STATE.dateRange = { start: startDate, end: endDate };

    showLoading();
    setStatus('loading', 'Cargando...');

    try {
        // Reset raw data
        STATE.raw.creditUsage = new Map();
        STATE.raw.interactions = new Map();
        STATE.raw.uniqueUsers = new Map();

        const errors = [];
        for (let i = 0; i < PROJECTS.length; i++) {
            const p = PROJECTS[i];
            updateLoadingProgress(`Proyecto ${i+1}/${PROJECTS.length}: ${p.name}`);
            try {
                const result = await fetchProjectData(p, startTime, endTime);
                STATE.raw.creditUsage.set(p.id, result.creditData);
                STATE.raw.interactions.set(p.id, result.interactionsData);
                STATE.raw.uniqueUsers.set(p.id, result.usersData);
            } catch (err) {
                console.error(`Error ${p.name}:`, err);
                errors.push(p.name);
                STATE.raw.creditUsage.set(p.id, []);
                STATE.raw.interactions.set(p.id, []);
                STATE.raw.uniqueUsers.set(p.id, []);
            }
        }

        // Discover models
        const modelSet = new Set();
        STATE.raw.creditUsage.forEach(items => items.forEach(item => { if (item.model) modelSet.add(item.model); }));
        STATE.discoveredModels = [...modelSet].sort();
        STATE.excludedModels = new Set();

        STATE.loaded = true;
        buildModelFilterUI();
        recalculate();
        renderAll();

        const totalCredItems = [...STATE.raw.creditUsage.values()].reduce((s, arr) => s + arr.length, 0);
        console.log(`ğŸ“Š Fetched: ${totalCredItems} credit items, ${STATE.discoveredModels.length} models discovered: ${STATE.discoveredModels.join(', ')}`);

        setStatus(errors.length > 0 ? 'warning' : '', errors.length > 0 ? `${errors.length} errores` : `Datos cargados (${STATE.discoveredModels.length} modelos)`);
    } catch (err) {
        console.error('Fatal fetch error:', err);
        setStatus('error', 'Error');
        alert('Error: ' + err.message);
    } finally {
        hideLoading();
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODEL FILTER UI
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildModelFilterUI() {
    const section = document.getElementById('modelFilterSection');
    section.style.display = STATE.discoveredModels.length > 0 ? '' : 'none';

    const container = document.getElementById('modelChips');
    container.innerHTML = STATE.discoveredModels.map(model => {
        // Count credits for this model
        let credits = 0;
        STATE.raw.creditUsage.forEach(items => items.forEach(item => {
            if (item.model === model) credits += item.count;
        }));
        return `<div class="chip active" data-model="${model}" onclick="toggleModel('${model}', this)">${model} (${fmtNum(credits)})</div>`;
    }).join('');

    updateFilterInfo();
}

function toggleModel(model, el) {
    if (STATE.excludedModels.has(model)) {
        STATE.excludedModels.delete(model);
        el.className = 'chip active';
    } else {
        // Don't allow excluding ALL models
        if (STATE.excludedModels.size >= STATE.discoveredModels.length - 1) {
            alert('Debe quedar al menos un modelo activo.');
            return;
        }
        STATE.excludedModels.add(model);
        el.className = 'chip excluded';
    }
    updateFilterInfo();
    recalculate();
    renderAll();
}

function updateFilterInfo() {
    const info = document.getElementById('filterInfo');
    if (STATE.excludedModels.size === 0) {
        info.textContent = 'Todos los modelos activos â€” mostrando datos completos';
    } else {
        const active = STATE.discoveredModels.filter(m => !STATE.excludedModels.has(m));
        info.textContent = `Modelos activos: ${active.join(', ')} â€” ${STATE.excludedModels.size} modelo(s) excluido(s) de crÃ©ditos`;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHASE 2 â€” CALCULATION ENGINE (Pure, no API calls)

   Applies model filters to Domain A only.
   Domain B (messaging) is never filtered.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function recalculate() {
    const C = {}; // computed object

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€ DOMAIN A: Credits (filtered) â”€â”€â”€â”€â”€â”€â”€â”€â”€
    C.credits = { total: 0, byProject: new Map(), byModel: new Map(), byMonth: new Map(), byDay: new Map(), byMonthAndModel: new Map(), topNodes: [] };

    // Also keep unfiltered total for comparison
    C.creditsUnfiltered = 0;

    const nodeMap = new Map(); // nodeID -> credits

    STATE.raw.creditUsage.forEach((items, projectId) => {
        let projTotal = 0;
        items.forEach(item => {
            C.creditsUnfiltered += item.count;

            // Apply model filter
            if (STATE.excludedModels.has(item.model)) return;

            const count = item.count;
            projTotal += count;
            C.credits.total += count;

            // By model
            const model = item.model || 'unknown';
            if (!C.credits.byModel.has(model)) C.credits.byModel.set(model, { input: 0, output: 0, total: 0 });
            const mData = C.credits.byModel.get(model);
            mData.total += count;
            if (item.type === 'llm-input') mData.input += count;
            else if (item.type === 'llm-output') mData.output += count;

            // By month
            const month = item.period.substring(0, 7);
            C.credits.byMonth.set(month, (C.credits.byMonth.get(month) || 0) + count);

            // By day
            const day = item.period.split('T')[0];
            C.credits.byDay.set(day, (C.credits.byDay.get(day) || 0) + count);

            // By month+model
            if (!C.credits.byMonthAndModel.has(month)) C.credits.byMonthAndModel.set(month, new Map());
            const mm = C.credits.byMonthAndModel.get(month);
            mm.set(model, (mm.get(model) || 0) + count);

            // Top nodes
            const nk = item.nodeID || 'unknown';
            nodeMap.set(nk, (nodeMap.get(nk) || 0) + count);
        });
        C.credits.byProject.set(projectId, projTotal);
    });

    // Sort top nodes
    C.credits.topNodes = [...nodeMap.entries()].sort((a, b) => b[1] - a[1]).slice(0, 10).map(([id, credits]) => ({ nodeID: id, credits }));

    // Derived credit metrics
    const planTotal = getPlanTotal();
    C.credits.costUSD = C.credits.total * COSTO_POR_CREDITO;
    C.credits.planPercent = planTotal > 0 ? (C.credits.total / planTotal) * 100 : 0;

    const months = [...C.credits.byMonth.keys()].sort();
    C.credits.burnRateMonthly = months.length > 0 ? C.credits.total / months.length : 0;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€ DOMAIN B: Messaging (never filtered) â”€â”€â”€â”€â”€â”€â”€â”€â”€
    C.messaging = { totalMessages: 0, totalUsers: 0, messagesByProject: new Map(), usersByProject: new Map(), messagesByMonth: new Map(), messagesByDay: new Map(), usersByMonth: new Map(), usersByDay: new Map() };

    STATE.raw.interactions.forEach((items, projectId) => {
        let projMsgs = 0;
        items.forEach(item => {
            projMsgs += item.count;
            C.messaging.totalMessages += item.count;
            const month = item.period.substring(0, 7);
            C.messaging.messagesByMonth.set(month, (C.messaging.messagesByMonth.get(month) || 0) + item.count);
            const day = item.period.split('T')[0];
            C.messaging.messagesByDay.set(day, (C.messaging.messagesByDay.get(day) || 0) + item.count);
        });
        C.messaging.messagesByProject.set(projectId, projMsgs);
    });

    STATE.raw.uniqueUsers.forEach((items, projectId) => {
        let projUsers = 0;
        items.forEach(item => {
            projUsers += item.count;
            C.messaging.totalUsers += item.count;
            const month = item.period.substring(0, 7);
            C.messaging.usersByMonth.set(month, (C.messaging.usersByMonth.get(month) || 0) + item.count);
            const day = item.period.split('T')[0];
            C.messaging.usersByDay.set(day, (C.messaging.usersByDay.get(day) || 0) + item.count);
        });
        C.messaging.usersByProject.set(projectId, projUsers);
    });

    C.messaging.msgsPerUser = C.messaging.totalUsers > 0 ? C.messaging.totalMessages / C.messaging.totalUsers : 0;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€ COMBINED METRICS â”€â”€â”€â”€â”€â”€â”€â”€â”€
    C.combined = {};
    C.combined.credPerMessage = C.messaging.totalMessages > 0 ? C.credits.total / C.messaging.totalMessages : 0;
    C.combined.credPerUser = C.messaging.totalUsers > 0 ? C.credits.total / C.messaging.totalUsers : 0;
    C.combined.hostingTotal = C.messaging.totalMessages * CREDITO_HOSTING;
    C.combined.grandTotal = C.credits.total + C.combined.hostingTotal;
    C.combined.grandTotalUSD = C.combined.grandTotal * COSTO_POR_CREDITO;

    // Per-project combined
    C.combined.credPerMsgByProject = new Map();
    C.combined.credPerUserByProject = new Map();
    PROJECTS.forEach(p => {
        const cred = C.credits.byProject.get(p.id) || 0;
        const msgs = C.messaging.messagesByProject.get(p.id) || 0;
        const users = C.messaging.usersByProject.get(p.id) || 0;
        C.combined.credPerMsgByProject.set(p.id, msgs > 0 ? cred / msgs : 0);
        C.combined.credPerUserByProject.set(p.id, users > 0 ? cred / users : 0);
    });

    // Projection
    if (STATE.dateRange.start && STATE.dateRange.end) {
        const dayStart = new Date(STATE.dateRange.start);
        const dayEnd = new Date(STATE.dateRange.end);
        const daysElapsed = Math.max(1, (dayEnd - dayStart) / (1000 * 60 * 60 * 24));
        const dailyRate = C.credits.total / daysElapsed;
        // Assume billing period = 30 days for projection
        C.combined.projectionLinear = dailyRate * 30;

        // Weighted: last 7 days
        const sortedDays = [...C.credits.byDay.entries()].sort((a,b) => a[0].localeCompare(b[0]));
        const last7 = sortedDays.slice(-7);
        if (last7.length > 0) {
            const recent7Total = last7.reduce((s, [,v]) => s + v, 0);
            const dailyRecent = recent7Total / last7.length;
            const daysRemaining = Math.max(0, 30 - daysElapsed);
            C.combined.projectionWeighted = C.credits.total + (dailyRecent * daysRemaining);
        } else {
            C.combined.projectionWeighted = C.combined.projectionLinear;
        }
    }

    STATE.computed = C;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER ALL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAll() {
    if (!STATE.computed) return;
    renderDashboard();
    if (STATE.activeTab === 'models') renderModelsTab();
    if (STATE.activeTab.startsWith('grade-')) renderGradeTab(parseInt(STATE.activeTab.split('-')[1]));
    if (STATE.activeTab === 'projections') renderProjectionsTab();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD RENDER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderDashboard() {
    const C = STATE.computed;
    const set = (id, val, sub) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
        const s = document.getElementById(id + 'Sub');
        if (s && sub !== undefined) s.textContent = sub;
    };

    // Domain A
    const filterNote = STATE.excludedModels.size > 0 ? ` (${STATE.excludedModels.size} modelo(s) excluido(s))` : '';
    set('kpiCreditsLLM', formatVal(C.credits.total), `datos directos de credit_usage API${filterNote}`);
    set('kpiCostUSD', '$' + fmtNum(C.credits.costUSD, 2), `a $${COSTO_POR_CREDITO}/crÃ©dito`);
    set('kpiPlanPct', C.credits.planPercent.toFixed(1) + '%', C.credits.planPercent >= 90 ? 'âš ï¸ Uso crÃ­tico' : C.credits.planPercent >= 75 ? 'AtenciÃ³n' : 'Normal');
    set('kpiBurnRate', formatVal(C.credits.burnRateMonthly), 'promedio mensual');

    // Domain B
    set('kpiMessages', fmtNum(C.messaging.totalMessages), 'mensajes de estudiantes');
    set('kpiUsers', fmtNum(C.messaging.totalUsers), 'usuarios Ãºnicos (suma por proyecto)');
    set('kpiMsgsPerUser', fmtNum(C.messaging.msgsPerUser, 1), 'engagement promedio');

    // Combined
    set('kpiCredPerMsg', fmtNum(C.combined.credPerMessage, 2), `crÃ©ditos LLM promedio por mensaje${filterNote}`);
    set('kpiCredPerUser', fmtNum(C.combined.credPerUser, 1), 'crÃ©ditos LLM por usuario');
    set('kpiGrandTotal', formatVal(C.combined.grandTotal), `LLM: ${fmtNum(C.credits.total)} + Hosting: ${fmtNum(C.combined.hostingTotal)}`);
    set('kpiProjection', formatVal(C.combined.projectionWeighted || 0), 'proyecciÃ³n ponderada (30 dÃ­as)');

    // Color plan percent
    const pctEl = document.getElementById('kpiPlanPct');
    if (pctEl) pctEl.style.color = C.credits.planPercent >= 90 ? 'var(--accent-rose)' : C.credits.planPercent >= 75 ? 'var(--accent-amber)' : 'var(--accent-amber)';

    renderMonthlyTable();
    renderCharts();
    renderInsights();
}

function renderMonthlyTable() {
    const C = STATE.computed;
    // Merge all months from both domains
    const allMonths = new Set([...C.credits.byMonth.keys(), ...C.messaging.messagesByMonth.keys()]);
    const months = [...allMonths].sort();
    const tbody = document.getElementById('monthlyTableBody');

    if (months.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text-muted);padding:2rem">Sin datos</td></tr>';
        return;
    }

    let prevCredits = null;
    tbody.innerHTML = months.map(month => {
        const credits = C.credits.byMonth.get(month) || 0;
        const msgs = C.messaging.messagesByMonth.get(month) || 0;
        const users = C.messaging.usersByMonth.get(month) || 0;
        const credPerMsg = msgs > 0 ? (credits / msgs).toFixed(2) : 'â€”';
        const costUSD = credits * COSTO_POR_CREDITO;

        let trend = 'â€”';
        if (prevCredits !== null) {
            const diff = credits - prevCredits;
            const pct = prevCredits > 0 ? (diff / prevCredits * 100).toFixed(1) : 0;
            trend = diff > 0 ? `<span style="color:var(--accent-rose)">â†‘ +${pct}%</span>` :
                    diff < 0 ? `<span style="color:var(--accent-emerald)">â†“ ${pct}%</span>` :
                    `<span style="color:var(--text-muted)">= 0%</span>`;
        }
        prevCredits = credits;

        const monthName = new Date(month + '-01').toLocaleDateString('es-MX', { year:'numeric', month:'long' });
        return `<tr>
            <td>${monthName}</td>
            <td class="mono text-right" style="color:var(--accent-indigo)">${fmtNum(credits, 0)}</td>
            <td class="mono text-right">${fmtNum(msgs)}</td>
            <td class="mono text-right">${fmtNum(users)}</td>
            <td class="mono text-right" style="color:var(--accent-amber)">${credPerMsg}</td>
            <td class="mono text-right" style="color:var(--accent-emerald)">$${fmtNum(costUSD, 2)}</td>
            <td>${trend}</td>
        </tr>`;
    }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CHART_DEFAULTS = {
    responsive: true, maintainAspectRatio: false,
    plugins: {
        legend: { labels: { color: '#8892a8', font: { family: "'DM Sans'", size: 11 }, boxWidth: 12, padding: 12 } },
        tooltip: { backgroundColor: '#1a2236', borderColor: '#2a3550', borderWidth: 1, titleColor: '#e8ecf4', bodyColor: '#8892a8', padding: 10, cornerRadius: 8 }
    },
    scales: {
        x: { ticks: { color: '#5a6478', font: { size: 10 } }, grid: { color: 'rgba(42,53,80,.3)' } },
        y: { ticks: { color: '#5a6478', font: { size: 10 } }, grid: { color: 'rgba(42,53,80,.3)' } }
    }
};

function renderCharts() {
    if (typeof Chart === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js';
        script.onload = () => renderCharts();
        document.head.appendChild(script);
        return;
    }
    const C = STATE.computed;

    // Monthly Credits Bar
    destroyChart('monthlyCredits');
    const months = [...C.credits.byMonth.keys()].sort();
    if (months.length > 0) {
        const ctx = document.getElementById('chartMonthlyCredits').getContext('2d');
        STATE.charts.monthlyCredits = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months.map(m => new Date(m + '-01').toLocaleDateString('es-MX', { month: 'short', year: '2-digit' })),
                datasets: [{ label: 'CrÃ©ditos LLM', data: months.map(m => C.credits.byMonth.get(m) || 0), backgroundColor: '#6366f1cc', borderColor: '#6366f1', borderWidth: 1 }]
            },
            options: { ...CHART_DEFAULTS, plugins: { ...CHART_DEFAULTS.plugins, legend: { display: false } } }
        });
    }

    // Daily Trend
    destroyChart('dailyTrend');
    const days = [...C.credits.byDay.keys()].sort();
    if (days.length > 0) {
        const values = days.map(d => C.credits.byDay.get(d) || 0);
        const ma7 = values.map((_, i) => {
            const sl = values.slice(Math.max(0, i - 6), i + 1);
            return sl.reduce((a, b) => a + b, 0) / sl.length;
        });
        const ctx = document.getElementById('chartDailyTrend').getContext('2d');
        STATE.charts.dailyTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: days.map(d => new Date(d).toLocaleDateString('es-MX', { day: '2-digit', month: 'short' })),
                datasets: [
                    { label: 'CrÃ©ditos/dÃ­a', data: values, borderColor: '#6366f180', backgroundColor: '#6366f115', fill: true, tension: 0.3, pointRadius: 1, borderWidth: 1.5 },
                    { label: 'Media mÃ³vil 7d', data: ma7, borderColor: '#f59e0b', backgroundColor: 'transparent', borderWidth: 2, pointRadius: 0, tension: 0.4, borderDash: [5, 3] }
                ]
            },
            options: CHART_DEFAULTS
        });
    }

    // By Grade
    destroyChart('byGrade');
    const gradeLabels = [], gradeData = [];
    PROJECTS.forEach((p, i) => {
        gradeLabels.push(`${p.grade}Â°`);
        gradeData.push(C.credits.byProject.get(p.id) || 0);
    });
    const ctxG = document.getElementById('chartByGrade').getContext('2d');
    STATE.charts.byGrade = new Chart(ctxG, {
        type: 'bar',
        data: { labels: gradeLabels, datasets: [{ label: 'CrÃ©ditos LLM', data: gradeData, backgroundColor: GRADE_COLORS.map(c => c + 'cc'), borderColor: GRADE_COLORS, borderWidth: 1 }] },
        options: { ...CHART_DEFAULTS, plugins: { ...CHART_DEFAULTS.plugins, legend: { display: false } } }
    });

    // By Model (Doughnut)
    destroyChart('byModel');
    const modelLabels = [], modelData = [], modelColors = [];
    let mi = 0;
    C.credits.byModel.forEach((data, model) => {
        modelLabels.push(model);
        modelData.push(data.total);
        modelColors.push(MODEL_COLORS[mi % MODEL_COLORS.length]);
        mi++;
    });
    if (modelLabels.length > 0) {
        const ctxM = document.getElementById('chartByModel').getContext('2d');
        STATE.charts.byModel = new Chart(ctxM, {
            type: 'doughnut',
            data: { labels: modelLabels, datasets: [{ data: modelData, backgroundColor: modelColors, borderColor: '#1a2236', borderWidth: 2 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { color: '#8892a8', font: { size: 11 }, padding: 8, boxWidth: 12 } },
                    tooltip: { ...CHART_DEFAULTS.plugins.tooltip, callbacks: { label: ctx => { const sum = modelData.reduce((a,b)=>a+b,0); const pct = sum > 0 ? (ctx.raw/sum*100).toFixed(1) : 0; return `${ctx.label}: ${fmtNum(ctx.raw,0)} (${pct}%)`; } } }
                }
            }
        });
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INSIGHTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderInsights() {
    const C = STATE.computed;
    const planTotal = getPlanTotal();
    const remaining = planTotal - C.credits.total;

    // Top model
    let topModel = '', topModelCred = 0;
    C.credits.byModel.forEach((data, model) => { if (data.total > topModelCred) { topModelCred = data.total; topModel = model; } });

    // Top grade
    let topGrade = null, topGradeCred = 0;
    PROJECTS.forEach(p => {
        const c = C.credits.byProject.get(p.id) || 0;
        if (c > topGradeCred) { topGradeCred = c; topGrade = p; }
    });

    // I/O ratio for top model
    const topModelData = C.credits.byModel.get(topModel);
    const ioRatio = topModelData && topModelData.output > 0 ? (topModelData.input / topModelData.output).toFixed(1) : 'N/A';

    const filterNote = STATE.excludedModels.size > 0 ? `<br><span class="badge badge-warning">${STATE.excludedModels.size} modelo(s) filtrado(s)</span>` : '';

    const grid = document.getElementById('insightsGrid');
    grid.innerHTML = `
    <div class="insight-card">
        <div class="insight-card-header"><div class="insight-icon" style="background:rgba(99,102,241,.15)">ğŸ¤–</div><div class="insight-card-title">Modelo Dominante</div></div>
        <div class="insight-card-body">
            <strong>${topModel}</strong> consume <strong>${fmtNum(topModelCred, 0)}</strong> crÃ©ditos
            (${C.credits.total > 0 ? (topModelCred / C.credits.total * 100).toFixed(1) : 0}% del total).
            Ratio input/output: <strong>${ioRatio}:1</strong>
            ${ioRatio !== 'N/A' && parseFloat(ioRatio) > 10 ? '<br>Ratio alto â€” posible optimizaciÃ³n de contexto/prompt.' : ''}
            ${filterNote}
        </div>
    </div>
    <div class="insight-card">
        <div class="insight-card-header"><div class="insight-icon" style="background:rgba(244,63,94,.15)">âš ï¸</div><div class="insight-card-title">Estado del Plan</div></div>
        <div class="insight-card-body">
            <strong>${fmtNum(C.credits.total, 0)}</strong> crÃ©ditos LLM consumidos (${C.credits.planPercent.toFixed(1)}% del plan).
            ${remaining > 0 ? `Quedan <strong>${fmtNum(remaining, 0)}</strong> crÃ©ditos.` : '<span class="badge badge-danger">PLAN EXCEDIDO</span>'}
            ${C.credits.burnRateMonthly > 0 ? `<br>Al ritmo actual (~${fmtNum(C.credits.burnRateMonthly, 0)}/mes), ${remaining > 0 ? `duran ~${fmtNum(remaining / C.credits.burnRateMonthly, 1)} meses` : 'ya excedido'}.` : ''}
        </div>
    </div>
    <div class="insight-card">
        <div class="insight-card-header"><div class="insight-icon" style="background:rgba(16,185,129,.15)">ğŸ«</div><div class="insight-card-title">Grado con Mayor Uso</div></div>
        <div class="insight-card-body">
            <strong>${topGrade ? topGrade.name : 'N/A'}</strong>: <strong>${fmtNum(topGradeCred, 0)}</strong> crÃ©ditos LLM
            (${C.messaging.messagesByProject.get(topGrade?.id) || 0} mensajes, ${C.messaging.usersByProject.get(topGrade?.id) || 0} usuarios).
        </div>
    </div>
    <div class="insight-card">
        <div class="insight-card-header"><div class="insight-icon" style="background:rgba(6,182,212,.15)">ğŸ’¡</div><div class="insight-card-title">Eficiencia</div></div>
        <div class="insight-card-body">
            <strong>${C.combined.credPerMessage.toFixed(2)}</strong> crÃ©ditos LLM por mensaje promedio.
            <strong>${C.messaging.msgsPerUser.toFixed(1)}</strong> mensajes por usuario promedio.
            <br>Costo por usuario: <strong>$${fmtNum(C.combined.credPerUser * COSTO_POR_CREDITO, 4)}</strong> USD en LLM.
        </div>
    </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODELS TAB
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderModelsTab() {
    const container = document.getElementById('tab-models');
    const C = STATE.computed;

    if (C.credits.byModel.size === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ¤–</div>Sin datos de modelos</div>';
        return;
    }

    let tableRows = '';
    C.credits.byModel.forEach((data, model) => {
        const pct = C.credits.total > 0 ? (data.total / C.credits.total * 100).toFixed(1) : 0;
        const ratio = data.output > 0 ? (data.input / data.output).toFixed(1) : 'N/A';
        const excluded = STATE.excludedModels.has(model);
        tableRows += `<tr${excluded ? ' style="opacity:.5;text-decoration:line-through"' : ''}>
            <td><strong>${model}</strong>${excluded ? ' <span class="badge badge-danger">excluido</span>' : ''}</td>
            <td class="mono text-right">${fmtNum(data.input, 0)}</td>
            <td class="mono text-right">${fmtNum(data.output, 0)}</td>
            <td class="mono text-right" style="color:var(--accent-indigo)">${fmtNum(data.total, 0)}</td>
            <td class="mono text-right">${pct}%</td>
            <td class="mono text-right">${ratio}</td>
            <td class="mono text-right" style="color:var(--accent-emerald)">$${fmtNum(data.total * COSTO_POR_CREDITO, 2)}</td>
        </tr>`;
    });

    container.innerHTML = `
    <div class="data-table-wrap">
        <div class="data-table-header"><div class="data-table-title">ğŸ¤– Desglose por Modelo LLM</div></div>
        <div style="overflow-x:auto"><table class="data-table">
            <thead><tr>
                <th>Modelo</th>
                <th class="text-right">CrÃ©d. Input</th>
                <th class="text-right">CrÃ©d. Output</th>
                <th class="text-right">Total</th>
                <th class="text-right">% del Total</th>
                <th class="text-right">Ratio I/O</th>
                <th class="text-right">Costo USD</th>
            </tr></thead>
            <tbody>${tableRows}</tbody>
        </table></div>
    </div>

    <div class="chart-panel">
        <div class="chart-panel-title">ğŸ“Š CrÃ©ditos por Modelo â€” EvoluciÃ³n Mensual</div>
        <div class="chart-wrap"><canvas id="chartModelMonthly"></canvas></div>
    </div>

    <div class="chart-panel">
        <div class="chart-panel-title">âš–ï¸ Input vs Output por Modelo</div>
        <div class="chart-wrap"><canvas id="chartModelIO"></canvas></div>
    </div>`;

    // Monthly stacked chart per model
    setTimeout(() => {
        if (typeof Chart === 'undefined') return;
        destroyChart('modelMonthly');
        const months = [...C.credits.byMonth.keys()].sort();
        const activeModels = STATE.discoveredModels.filter(m => !STATE.excludedModels.has(m));
        const datasets = activeModels.map((model, i) => ({
            label: model,
            data: months.map(m => {
                const mm = C.credits.byMonthAndModel.get(m);
                return mm ? (mm.get(model) || 0) : 0;
            }),
            backgroundColor: MODEL_COLORS[i % MODEL_COLORS.length] + 'cc',
            borderColor: MODEL_COLORS[i % MODEL_COLORS.length],
            borderWidth: 1,
        }));
        const ctx = document.getElementById('chartModelMonthly');
        if (ctx) {
            STATE.charts.modelMonthly = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: { labels: months.map(m => new Date(m + '-01').toLocaleDateString('es-MX', { month: 'short', year: '2-digit' })), datasets },
                options: { ...CHART_DEFAULTS, scales: { ...CHART_DEFAULTS.scales, x: { ...CHART_DEFAULTS.scales.x, stacked: true }, y: { ...CHART_DEFAULTS.scales.y, stacked: true } } }
            });
        }

        // I/O Bar chart
        destroyChart('modelIO');
        const ioLabels = [], ioInput = [], ioOutput = [];
        C.credits.byModel.forEach((data, model) => {
            ioLabels.push(model);
            ioInput.push(data.input);
            ioOutput.push(data.output);
        });
        const ctxIO = document.getElementById('chartModelIO');
        if (ctxIO) {
            STATE.charts.modelIO = new Chart(ctxIO.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ioLabels,
                    datasets: [
                        { label: 'Input', data: ioInput, backgroundColor: '#6366f1cc' },
                        { label: 'Output', data: ioOutput, backgroundColor: '#10b981cc' },
                    ]
                },
                options: CHART_DEFAULTS
            });
        }
    }, 50);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GRADE TAB
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderGradeTab(grade) {
    const container = document.getElementById(`tab-grade-${grade}`);
    const C = STATE.computed;
    const proj = PROJECTS.find(p => p.grade === grade);
    if (!proj) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div>Grado no encontrado</div>'; return; }

    const credits = C.credits.byProject.get(proj.id) || 0;
    const msgs = C.messaging.messagesByProject.get(proj.id) || 0;
    const users = C.messaging.usersByProject.get(proj.id) || 0;
    const credPerMsg = C.combined.credPerMsgByProject.get(proj.id) || 0;
    const msgsPerUser = users > 0 ? msgs / users : 0;

    if (credits === 0 && msgs === 0) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div>No hay datos para grado ${grade}Â°</div>`;
        return;
    }

    // Build per-month data for this grade from raw
    const monthlyCredits = new Map(), monthlyMsgs = new Map(), monthlyUsers = new Map();
    (STATE.raw.creditUsage.get(proj.id) || []).forEach(item => {
        if (STATE.excludedModels.has(item.model)) return;
        const m = item.period.substring(0, 7);
        monthlyCredits.set(m, (monthlyCredits.get(m) || 0) + item.count);
    });
    (STATE.raw.interactions.get(proj.id) || []).forEach(item => {
        const m = item.period.substring(0, 7);
        monthlyMsgs.set(m, (monthlyMsgs.get(m) || 0) + item.count);
    });
    (STATE.raw.uniqueUsers.get(proj.id) || []).forEach(item => {
        const m = item.period.substring(0, 7);
        monthlyUsers.set(m, (monthlyUsers.get(m) || 0) + item.count);
    });

    const allMonths = new Set([...monthlyCredits.keys(), ...monthlyMsgs.keys()]);
    const months = [...allMonths].sort();
    const cId = `chartG${grade}`;

    container.innerHTML = `
    <div style="font-size:.7rem;font-weight:700;color:var(--accent-indigo);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.5rem">Dominio A â€” CrÃ©ditos</div>
    <div class="metrics-row">
        <div class="metric-card mc-indigo"><div class="metric-label">CrÃ©ditos LLM</div><div class="metric-value">${formatVal(credits)}</div></div>
        <div class="metric-card mc-emerald"><div class="metric-label">Costo USD</div><div class="metric-value">$${fmtNum(credits * COSTO_POR_CREDITO, 2)}</div></div>
    </div>
    <div style="font-size:.7rem;font-weight:700;color:var(--accent-cyan);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.5rem">Dominio B â€” MensajerÃ­a</div>
    <div class="metrics-row">
        <div class="metric-card mc-cyan"><div class="metric-label">Mensajes</div><div class="metric-value">${fmtNum(msgs)}</div></div>
        <div class="metric-card mc-violet"><div class="metric-label">Usuarios</div><div class="metric-value">${fmtNum(users)}</div></div>
        <div class="metric-card mc-blue"><div class="metric-label">Msgs / Usuario</div><div class="metric-value">${fmtNum(msgsPerUser, 1)}</div></div>
    </div>
    <div style="font-size:.7rem;font-weight:700;color:var(--accent-amber);text-transform:uppercase;letter-spacing:.08em;margin-bottom:.5rem">Conjuntas</div>
    <div class="metrics-row">
        <div class="metric-card mc-orange"><div class="metric-label">CrÃ©d. LLM / Msg</div><div class="metric-value">${fmtNum(credPerMsg, 2)}</div></div>
        <div class="metric-card mc-rose"><div class="metric-label">CrÃ©d. LLM / Usuario</div><div class="metric-value">${fmtNum(C.combined.credPerUserByProject.get(proj.id) || 0, 1)}</div></div>
    </div>

    <div class="two-col">
        <div class="chart-panel"><div class="chart-panel-title">ğŸ“Š CrÃ©ditos LLM â€” ${grade}Â°</div><div class="chart-wrap"><canvas id="${cId}Monthly"></canvas></div></div>
        <div class="chart-panel"><div class="chart-panel-title">ğŸ“ˆ Mensajes â€” ${grade}Â°</div><div class="chart-wrap"><canvas id="${cId}Msgs"></canvas></div></div>
    </div>

    <div class="data-table-wrap">
        <div class="data-table-header"><div class="data-table-title">ğŸ“… Detalle Mensual â€” ${grade}Â°</div></div>
        <div style="overflow-x:auto"><table class="data-table">
            <thead><tr><th>Mes</th><th class="text-right">CrÃ©d. LLM</th><th class="text-right">Mensajes</th><th class="text-right">Usuarios</th><th class="text-right">CrÃ©d/Msg</th><th class="text-right">Costo USD</th></tr></thead>
            <tbody>${months.map(m => {
                const mc = monthlyCredits.get(m) || 0;
                const mm = monthlyMsgs.get(m) || 0;
                const mu = monthlyUsers.get(m) || 0;
                return `<tr>
                    <td>${new Date(m+'-01').toLocaleDateString('es-MX',{month:'long',year:'numeric'})}</td>
                    <td class="mono text-right" style="color:var(--accent-indigo)">${fmtNum(mc, 0)}</td>
                    <td class="mono text-right">${fmtNum(mm)}</td>
                    <td class="mono text-right">${fmtNum(mu)}</td>
                    <td class="mono text-right" style="color:var(--accent-amber)">${mm > 0 ? (mc/mm).toFixed(2) : 'â€”'}</td>
                    <td class="mono text-right" style="color:var(--accent-emerald)">$${fmtNum(mc * COSTO_POR_CREDITO, 2)}</td>
                </tr>`;
            }).join('')}</tbody>
        </table></div>
    </div>`;

    // Charts
    setTimeout(() => {
        if (typeof Chart === 'undefined') return;
        destroyChart(`g${grade}Monthly`);
        destroyChart(`g${grade}Msgs`);

        const ctxC = document.getElementById(`${cId}Monthly`);
        if (ctxC && months.length > 0) {
            STATE.charts[`g${grade}Monthly`] = new Chart(ctxC.getContext('2d'), {
                type: 'bar',
                data: { labels: months.map(m => new Date(m+'-01').toLocaleDateString('es-MX',{month:'short',year:'2-digit'})), datasets: [{ label: 'CrÃ©ditos LLM', data: months.map(m => monthlyCredits.get(m) || 0), backgroundColor: '#6366f1cc', borderColor: '#6366f1', borderWidth: 1 }] },
                options: { ...CHART_DEFAULTS, plugins: { ...CHART_DEFAULTS.plugins, legend: { display: false } } }
            });
        }
        const ctxM = document.getElementById(`${cId}Msgs`);
        if (ctxM && months.length > 0) {
            STATE.charts[`g${grade}Msgs`] = new Chart(ctxM.getContext('2d'), {
                type: 'bar',
                data: { labels: months.map(m => new Date(m+'-01').toLocaleDateString('es-MX',{month:'short',year:'2-digit'})), datasets: [{ label: 'Mensajes', data: months.map(m => monthlyMsgs.get(m) || 0), backgroundColor: '#06b6d4cc', borderColor: '#06b6d4', borderWidth: 1 }] },
                options: { ...CHART_DEFAULTS, plugins: { ...CHART_DEFAULTS.plugins, legend: { display: false } } }
            });
        }
    }, 50);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROJECTIONS TAB
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderProjectionsTab() {
    const C = STATE.computed;

    // Filtered projection metrics
    const filteredNote = STATE.excludedModels.size > 0 ? ` (sin ${[...STATE.excludedModels].join(', ')})` : ' (sin filtros)';
    document.getElementById('projFilteredMetrics').innerHTML = `
        <div class="metric-card mc-indigo"><div class="metric-label">CrÃ©d. LLM Filtrados</div><div class="metric-value">${fmtNum(C.credits.total, 0)}</div><div class="metric-sub">${filteredNote}</div></div>
        <div class="metric-card mc-amber"><div class="metric-label">CrÃ©d/Msg (Filtrado)</div><div class="metric-value">${fmtNum(C.combined.credPerMessage, 2)}</div></div>
        <div class="metric-card mc-emerald"><div class="metric-label">Costo USD (Filtrado)</div><div class="metric-value">$${fmtNum(C.credits.costUSD, 2)}</div></div>
        ${STATE.excludedModels.size > 0 ? `<div class="metric-card mc-rose"><div class="metric-label">CrÃ©d. Excluidos</div><div class="metric-value">${fmtNum(C.creditsUnfiltered - C.credits.total, 0)}</div><div class="metric-sub">de modelos suprimidos</div></div>` : ''}`;

    // Per-project table
    const tbody = document.getElementById('projFilteredTableBody');
    tbody.innerHTML = PROJECTS.map(p => {
        const cred = C.credits.byProject.get(p.id) || 0;
        const msgs = C.messaging.messagesByProject.get(p.id) || 0;
        const credPerMsg = msgs > 0 ? (cred / msgs).toFixed(2) : 'â€”';
        return `<tr>
            <td><strong>${p.grade}Â°</strong></td>
            <td class="mono text-right" style="color:var(--accent-indigo)">${fmtNum(cred, 0)}</td>
            <td class="mono text-right">${fmtNum(msgs)}</td>
            <td class="mono text-right" style="color:var(--accent-amber)">${credPerMsg}</td>
            <td class="mono text-right" style="color:var(--accent-emerald)">$${fmtNum(cred * COSTO_POR_CREDITO, 2)}</td>
        </tr>`;
    }).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--text-muted)">Sin datos</td></tr>';
}

function runCapacity() {
    if (!STATE.loaded) { alert('Carga datos primero'); return; }
    const C = STATE.computed;
    const totalUsers = parseInt(document.getElementById('capUsers').value) || 100;
    const msgsYear = parseInt(document.getElementById('capMsgsYear').value) || 1000;
    const credPerMsg = C.combined.credPerMessage;

    // LLM credits per user per year
    const credLLMPerUser = credPerMsg * msgsYear;
    const hostingPerUser = msgsYear * CREDITO_HOSTING;
    const totalCredPerUser = credLLMPerUser + hostingPerUser;
    const totalCredAll = totalCredPerUser * totalUsers;
    const costPerUser = totalCredPerUser * COSTO_POR_CREDITO;
    const costAll = totalCredAll * COSTO_POR_CREDITO;
    const planTotal = getPlanTotal();

    const filterNote = STATE.excludedModels.size > 0 ? ` (basado en modelos filtrados: ${STATE.discoveredModels.filter(m => !STATE.excludedModels.has(m)).join(', ')})` : '';

    document.getElementById('capMetrics').innerHTML = `
        <div class="metric-card mc-indigo"><div class="metric-label">CrÃ©ditos Totales/AÃ±o</div><div class="metric-value">${fmtNum(totalCredAll, 0)}</div><div class="metric-sub">LLM: ${fmtNum(credLLMPerUser * totalUsers, 0)} + Hosting: ${fmtNum(hostingPerUser * totalUsers, 0)}</div></div>
        <div class="metric-card mc-amber"><div class="metric-label">Costo Total/AÃ±o</div><div class="metric-value">$${fmtNum(costAll, 2)}</div></div>
        <div class="metric-card mc-emerald"><div class="metric-label">$/Usuario/AÃ±o</div><div class="metric-value">$${fmtNum(costPerUser, 2)}</div><div class="metric-sub">${fmtNum(credPerMsg, 2)} crÃ©d/msg Ã— ${msgsYear} msgs${filterNote}</div></div>
        <div class="metric-card ${totalCredAll <= planTotal ? 'mc-emerald' : 'mc-rose'}"><div class="metric-label">${totalCredAll <= planTotal ? 'Dentro del Plan' : 'Excede el Plan'}</div><div class="metric-value">${(totalCredAll/planTotal*100).toFixed(1)}%</div><div class="metric-sub">${fmtNum(totalCredAll, 0)} / ${fmtNum(planTotal, 0)}</div></div>`;

    document.getElementById('capResults').style.display = '';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSV EXPORT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function exportCSV() {
    if (!STATE.loaded) { alert('Carga datos primero'); return; }
    const C = STATE.computed;
    let csv = 'Grado,CrÃ©ditos LLM,Mensajes,Usuarios,CrÃ©d/Msg,Costo USD\n';
    PROJECTS.forEach(p => {
        const cred = C.credits.byProject.get(p.id) || 0;
        const msgs = C.messaging.messagesByProject.get(p.id) || 0;
        const users = C.messaging.usersByProject.get(p.id) || 0;
        csv += `"${p.name}",${cred},${msgs},${users},${msgs > 0 ? (cred/msgs).toFixed(2) : 0},${(cred*COSTO_POR_CREDITO).toFixed(2)}\n`;
    });

    csv += '\n\nDetalle Mensual\nMes,CrÃ©ditos LLM,Mensajes,Usuarios,CrÃ©d/Msg,Costo USD\n';
    const months = [...new Set([...C.credits.byMonth.keys(), ...C.messaging.messagesByMonth.keys()])].sort();
    months.forEach(m => {
        const cred = C.credits.byMonth.get(m) || 0;
        const msgs = C.messaging.messagesByMonth.get(m) || 0;
        const users = C.messaging.usersByMonth.get(m) || 0;
        csv += `"${m}",${cred},${msgs},${users},${msgs > 0 ? (cred/msgs).toFixed(2) : 0},${(cred*COSTO_POR_CREDITO).toFixed(2)}\n`;
    });

    csv += '\n\nModelos LLM\nModelo,Input,Output,Total,% Total,Costo USD\n';
    C.credits.byModel.forEach((data, model) => {
        csv += `"${model}",${data.input},${data.output},${data.total},${C.credits.total > 0 ? (data.total/C.credits.total*100).toFixed(1) : 0},${(data.total*COSTO_POR_CREDITO).toFixed(2)}\n`;
    });

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `xolo-credits-v2-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}
</script>
</body>
</html>
